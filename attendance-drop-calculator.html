<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aggregate Attendance Calculator</title>
  <!-- <link rel="icon" href="/thgd/favicon.ico" type="image/x-icon"> -->

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.6/lottie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

  <script>
    // This configures Tailwind to use the 'class' strategy for dark mode
    tailwind.config = {
      darkMode: 'class',
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f0f4f8;
      --bg-secondary: #ffffff;
      --bg-gradient: linear-gradient(180deg, #f0f4f8 0%, #e1e8ed 100%);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --border: #e2e8f0;
      --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
      --gradient-error: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --shadow-glow: 0 0 20px rgba(59, 130, 246, 0.3);
      --radius: 1rem;
      --radius-lg: 1.5rem;
      --radius-full: 9999px;
      --meshad: rgba(31, 38, 135, 0.4);
      --foreground: 222 47% 11%;
      --primary: 220 85% 56%;
      --accent: 0 20% 98%;
      --secondary: 200 90% 40%;
      --muted: 220 15% 88%;
      --muted-foreground: 220 8% 40%;
      --shad: rgba(0, 0, 0, 0.75);
      --shadhov: rgba(0, 0, 0, 0.9);

    }

    .dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-gradient: linear-gradient(180deg, #0f172a 0%, #020617 100%);
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #334155;
      --success: #34d399;
      --warning: #facc15;
      --error: #f87171;
      --meshad: rgba(216, 251, 255, 0.4);
      --foreground: 0 0% 98%;
      --primary: 280 85% 68%;
      --accent: 330 95% 68%;
      --secondary: 190 95% 55%;
      --muted: 240 10% 20%;
      --muted-foreground: 240 5% 65%;
      --shad: rgba(0, 0, 0, 0.85);
      --shadhov: rgba(0, 0, 0, 1);
    }

    body,
    a,
    button,
    input,
    select,
    label,
    textarea {
      cursor: none;
    }

    /* Scrollbar Track */
    ::-webkit-scrollbar {
      width: 7px;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background-color: #2a86ff;
      border-radius: 10px;
      border: 0.1px solid #f1f1f1;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #555;
    }

    /* Replace your existing body style */
    body {
      /* font-family: 'Inter', sans-serif; */
      /* Light Mode Gradient */
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      /* transition: background 0.5s ease; */
    }

    .dark body {
      font-family: 'Inter', sans-serif;
      background: hsl(240 20% 5%);
      /* --background from Thingdom */
      color: hsl(0 0% 98%);
      /* --foreground from Thingdom */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow-x: hidden;
      cursor: none;
      /* We will add the custom cursor */
    }

    .dark body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
      z-index: -1;
      /* Place it behind content */
    }

    /* Replace your existing .card style */
    .card {
      background: var(--glass-bg-light);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border-radius: 1.25rem;
      /* rounded-2xl */
      border: 1px solid var(--glass-border-light);
      box-shadow: 0 8px 32px 10px rgba(31, 38, 135, 0.3);
      transition: background 0.3s ease, border 0.3s ease;
    }

    /* Add this new style to your <style> block */
    .gradient-text {
      background: linear-gradient(45deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
    }

    textarea {
      min-height: 200px;
    }

    #max-drop-overlay.show #max-drop-card {
      transform: translateY(0);
    }

    @media (max-width: 438px) {
      ::-webkit-scrollbar {
        display: none;
      }
    }

    .toggle-checkbox:checked+.toggle-label {
      background-color: #3b82f6;
      /* Tailwind's blue-500 */
    }

    .toggle-checkbox:checked+.toggle-label span {
      transform: translateX(24px);
      /* move the knob */
    }

    .shepherd-element {
      border-radius: 0.75rem;
      /* rounded-xl */
      border: 1px solid;
      border-color: #e5e7eb;
      /* border-gray-200 */
    }

    .dark .shepherd-element {
      border-color: #374151;
      /* dark:border-gray-700 */
    }

    .shepherd-header {
      background-color: #f9fafb;
      /* bg-gray-50 */
      padding: 0.75rem 1rem;
      border-top-left-radius: 0.75rem;
      border-top-right-radius: 0.75rem;
    }

    .dark .shepherd-header {
      background-color: #374151;
      /* dark:bg-gray-700 */
    }

    .shepherd-text {
      padding: 1rem;
      font-size: 0.875rem;
      /* text-sm */
      color: #374151;
      /* text-gray-700 */
    }

    .dark .shepherd-text {
      color: #d1d5db;
      /* dark:text-gray-300 */
    }

    .shepherd-button {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      /* rounded-lg */
      font-weight: 600;
      /* font-semibold */
      transition-property: background-color;
      transition-duration: 150ms;
    }

    .shepherd-button:not(.shepherd-button-secondary) {
      background-color: #3b82f6;
      /* bg-blue-500 */
      color: white;
    }

    .shepherd-button:not(.shepherd-button-secondary):hover {
      background-color: #2563eb;
      /* hover:bg-blue-600 */
    }

    .shepherd-button.shepherd-button-secondary {
      background-color: #e5e7eb;
      /* bg-gray-200 */
      color: #374151;
      /* text-gray-700 */
    }

    .dark .shepherd-button.shepherd-button-secondary {
      background-color: #4b5563;
      /* dark:bg-gray-600 */
      color: #f9fafb;
      /* dark:text-gray-100 */
    }

    .tooltip-btn {
      position: relative;
    }

    /* This is the tooltip text bubble */
    .tooltip-btn::after {
      /* Get the text from the data-tooltip attribute */
      content: attr(data-tooltip);

      /* Positioning */
      position: absolute;
      bottom: 100%;
      /* Position it above the button */
      left: 50%;
      transform: translateX(-50%);
      /* Center it horizontally */
      margin-bottom: 8px;
      /* Space between button and tooltip */

      /* Styling - using our theme variables! */
      background-color: #1f2937;
      /* A dark background for both themes */
      color: #f9fafb;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      white-space: nowrap;
      /* Keep the text on one line */

      /* Drop shadow for depth */
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);

      /* Initial state: hidden and slightly moved down */
      opacity: 0;
      visibility: hidden;
      transform: translate(-50%, 5px);
      /* Start slightly down for a float-up effect */
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, visibility 0.2s;

      /* Make sure the tooltip doesn't block mouse events */
      pointer-events: none;
    }

    /* This shows the tooltip on hover */
    .tooltip-btn:hover::after {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, 0);
      /* Move back to final position */
    }

    /* Add these styles for inputs and textareas */
    input[type="number"],
    input[type="file"],
    select,
    textarea {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(209, 213, 219, 0.8);
      transition: all 0.2s ease-in-out;
    }

    input:focus,
    select:focus,
    textarea:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4);
      border-color: #3b82f6 !important;
    }

    /* Style the main Calculate button */
    .calculate-btn {
      background: linear-gradient(45deg, #2563eb, #7c3aed);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .calculate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .calculate-btn:active {
      transform: translateY(0px) scale(0.98);
      box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    @keyframes drop-success {
      0% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
        /* blue-500 */
        transform: scale(1);
      }

      70% {
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
        transform: scale(1.02);
      }

      100% {
        transform: scale(1);
      }
    }

    .drop-success-animation {
      animation: drop-success 0.8s ease-out;
    }

    @keyframes pulse-warning {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4);
        /* yellow-500 with opacity */
      }

      50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
      }
    }

    .pulse-warning-animation {
      animation: pulse-warning 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
    }

    #toggle-sticky-message-fab.active {
      background-color: #7c3aed;
      /* purple-600 */
      box-shadow: 0 0 20px rgba(124, 58, 237, 0.6);
    }

    #sticky-message-bar.genie-hide #sticky-message-content {
      transform: translateY(80vh) translateX(30vw) scale(0);
      opacity: 0;
    }

    .gradient-text-success {
      background: linear-gradient(45deg, #10b981, #6ee7b7);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .gradient-text-warning {
      background: linear-gradient(45deg, #f59e0b, #fcd34d);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .gradient-text-danger {
      background: linear-gradient(45deg, #ef4444, #f87171);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Glow effect classes for the overlay card */
    .glow-success {
      box-shadow: 0 -10px 50px -15px rgba(16, 185, 129, 0.5);
    }

    .glow-warning {
      box-shadow: 0 -10px 50px -15px rgba(245, 158, 11, 0.5);
    }

    .glow-danger {
      box-shadow: 0 -10px 50px -15px rgba(239, 68, 68, 0.5);
    }

    /* ADD this new class */
    .glass {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Remove background from the original card in dark mode */
    .dark .card {
      background: transparent;
      /* This will let the glass effect show */
      border: 1px solid var(--glass-border-dark);
      border-color: transparent;
      box-shadow: 0 8px 32px 10px rgba(124, 58, 237, 0.3);
    }

    .dark .gradient-text {
      background: linear-gradient(135deg, hsl(280 85% 68%), hsl(190 95% 55%));
      -webkit-background-clip: text;
      background-clip: text;
      animation: gradient-shift 6s ease infinite;
      background-size: 200% 200%;
    }

    @keyframes gradient-shift {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    .dark .calculate-btn {
      background: linear-gradient(135deg, hsl(280 85% 68%), hsl(260 90% 58%));
      box-shadow: 0 0 40px hsl(280 85% 68% / 0.4);
    }

    .dark .calculate-btn:hover {
      box-shadow: 0 0 50px hsl(280 85% 68% / 0.6);
    }

    .dark input[type="number"],
    .dark input[type="file"],
    .dark select,
    .dark textarea {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.15);
      color: #f9fafb;
    }

    .dark input:focus,
    .dark select:focus,
    .dark textarea:focus {
      box-shadow: 0 0 0 3px hsl(280 85% 68% / 0.4);
      border-color: hsl(280 85% 68%) !important;
    }

    /* ADD these cursor styles */
    .cursor {
      width: 20px;
      height: 20px;
      border: 2px solid hsl(280 85% 68%);
      /* --primary color */
      border-radius: 50%;
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      transition: all 0.1s ease;
      transform: translate(-50%, -50%);
      mix-blend-mode: difference;
    }

    .cursor-glow {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, hsl(280 85% 68% / 0.15), transparent 70%);
      position: fixed;
      pointer-events: none;
      z-index: 9998;
      transform: translate(-50%, -50%);
      transition: all 0.3s ease;
    }

    .cursor.active {
      transform: translate(-50%, -50%) scale(1.5);
      background: hsl(280 85% 68% / 0.3);
    }

    /* --- Related Articles Section --- */
    .related-articles {
      margin-top: 4rem;
      padding-top: 4rem;
      border-top: 1px solid hsl(var(--muted) / 0.5);
    }

    .section-title {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 2.5rem;
      color: hsl(var(--foreground));
    }

    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }

    .article-card {
      background-color: hsl(var(--secondary) / 0.1);
      border: 1px solid hsl(var(--muted) / 0.5);
      border-radius: 1rem;
      text-decoration: none;
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .article-card:hover {
      transform: translateY(-5px);
      border-color: hsl(var(--primary));
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .article-card-content {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .article-category {
      font-size: 0.75rem;
      font-weight: 600;
      color: hsl(var(--primary));
      text-transform: uppercase;
      margin-bottom: 0.75rem;
    }

    .article-card h4 {
      font-size: 1.1rem;
      font-weight: 600;
      color: hsl(var(--foreground));
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }

    .article-card p {
      font-size: 0.9rem;
      color: hsl(var(--muted-foreground));
      line-height: 1.6;
      flex-grow: 1;
    }

    .read-more {
      margin-top: 1rem;
      font-weight: 600;
      color: hsl(var(--accent));
      align-self: flex-start;
      transition: text-shadow ease-in-out 0.2s;
      text-shadow: 0 1px 5px var(--shad);
    }

    .read-more:hover {
      text-shadow: 0 2px 4px var(--shadhov);
    }


    .read-more .arrow {
      display: inline-block;
      transition: all 0.3s ease;
    }

    .article-card:hover .arrow {
      font-size: 1.3rem;
      font-weight: bolder;
      transform: translateX(6.5px);
    }
  </style>
</head>

<body class="py-4 px-1 sm:p-8 bg-gray-50 dark:bg-gray-900">
  <div class="cursor"></div>
  <div class="cursor-glow"></div>
  <div class="blob-wrapper fixed top-0 left-0 w-full h-full pointer-events-none z-[-1] overflow-hidden">
    <div class="blob absolute top-[10%] left-[-10%] w-[30rem] h-[30rem] rounded-full filter blur-[140px] opacity-25"
      style="background: linear-gradient(135deg, hsl(280 85% 68%), hsl(260 90% 58%)); animation: float 8s ease-in-out infinite;">
    </div>
    <div class="blob absolute top-[40%] right-[-10%] w-[35rem] h-[35rem] rounded-full filter blur-[140px] opacity-25"
      style="background: linear-gradient(135deg, hsl(190 95% 55%), hsl(170 90% 60%)); animation: float 8s ease-in-out infinite 2s;">
    </div>
    <div class="blob absolute bottom-[10%] left-[30%] w-[28rem] h-[28rem] rounded-full filter blur-[140px] opacity-25"
      style="background: linear-gradient(135deg, hsl(330 95% 68%), hsl(310 90% 58%)); animation: float 8s ease-in-out infinite 4s;">
    </div>
  </div>

  <div id="sticky-message-bar" class="fixed top-4 left-1/2 -translate-x-1/2 z-40 w-full max-w-2xl px-4 hidden">
    <div id="sticky-message-content"
      class="p-3 rounded-lg text-center font-medium shadow-lg transition-all duration-300 transform -translate-y-20 opacity-0">
    </div>
  </div>

  <div id="app" class="max-w-4xl mx-auto">
    <header class="text-center mb-2" style="animation: fadeIn 0.6s ease-out;">
      <h1 class="text-4xl font-bold tracking-tight gradient-text" style="animation: float 4s ease-in-out infinite;">
        The Attendance Alchemist</h1>
      <p class="text-gray-500 mt-2">Calculate max future absences to stay above a target percentage.</p>
    </header>
    <div class="flex justify-center mb-4">
      <button id="theme-toggle" type="button"
        class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
        <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
        <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg">
          <path
            d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z"
            fill-rule="evenodd" clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
    <div class="card bg-white dark:glass py-6 px-3 sm:p-8 rounded-xl border border-gray-200"
      style="animation: scaleIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);">
      <!-- Instructions and Inputs -->
      <div class="space-y-6">

        <!-- <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV or Excel File:</label>
          <input type="file" id="file-upload" accept=".csv, .xlsx"
            class="w-full p-2 border border-gray-300 rounded-lg bg-white cursor-pointer"
            onchange="handleFileUpload(event)">
          <p class="text-xs text-gray-500 mt-1">Accepted formats: .csv, .xlsx</p>
        </div> -->

        <!-- Dropzone for file upload -->
        <div id="dropzone"
          class="mt-4 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10 cursor-pointer hover:border-blue-500 hover:bg-blue-50 dark:border-gray-100/25 dark:hover:bg-blue-500/10">
          <div class="text-center">
            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 24 24"
              aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
            </svg>
            <div class="mt-4 flex text-sm leading-6 text-gray-600">
              <label for="file-upload"
                class="relative font-semibold text-blue-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-blue-600 focus-within:ring-offset-2 hover:text-blue-500">
                <span>Upload a file</span>
                <input id="file-upload" name="file-upload" type="file" class="sr-only"
                  onchange="handleFileUpload(event)">
              </label>
              <p class="pl-1 dark:text-gray-300">or drag and drop</p>
            </div>
            <p class="text-xs leading-5 text-gray-600 dark:text-gray-400">CSV or XLSX up to 10MB</p>
          </div>
        </div>



        <!-- Target Percentage Input -->
        <div>
          <label for="target-percent" class="block text-sm font-medium text-gray-700 dark:text-white mb-2">Target
            Attendance
            Percentage
            (e.g., 65):</label>
          <input type="number" id="target-percent" value="65" min="1" max="100"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            oninput="calculateHours()">
        </div>

        <!-- Data Input Area -->
        <div id="data-input-wrapper" class="hidden">

          <div>
            <label for="data-input" class="block text-sm font-medium text-gray-700 dark:text-white mb-2">Paste
              Attendance
              Data
              Here:</label>
            <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Ensure your data includes columns for 'Present',
              'OD', and
              'Absent'.</p>


            <div class="relative">
              <textarea id="data-input"
                class="w-full p-3 pr-10 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none transition duration-150"
                placeholder="Paste your table data (tab-separated or space-separated) here..."></textarea>

              <!-- Clear Button Inside Textarea -->
              <button onclick="clearTextarea()" title="Clear Attendance Data"
                class="absolute top-2 right-2 text-gray-500 hover:text-red-600 text-lg transition-transform duration-200 transform hover:-translate-y-1 focus:outline-none"
                aria-label="Clear textarea">
                🗑️
              </button>
            </div>
          </div>
        </div>

        <div class="flex justify-center gap-3 mt-2">
          <button id="paste-btn"
            class="tooltip-btn p-2 text-white text-xl rounded-lg shadow-md bg-gradient-to-r from-indigo-500 to-blue-400 hover:from-indigo-600 hover:to-blue-500 transition-transform duration-200 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-blue-300"
            data-tooltip="Paste from Clipboard">
            📋
          </button>

          <button onclick="saveProgress()"
            class="tooltip-btn p-2 text-white text-xl rounded-lg shadow-md bg-gradient-to-r from-emerald-500 to-green-400 hover:from-emerald-600 hover:to-green-500 transition-transform duration-200 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-green-300"
            data-tooltip="Save Progress">
            💾
          </button>

          <button onclick="loadProgress()"
            class="tooltip-btn p-2 text-white text-xl rounded-lg shadow-md bg-gradient-to-r from-gray-600 to-gray-800 hover:from-gray-700 hover:to-gray-900 transition-transform duration-200 transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-gray-400"
            data-tooltip="Resume Last Session">
            ↩️
          </button>
        </div>

        <!-- Calculate Button (for clarity, though it auto-updates) -->
        <button onclick="calculateHours()" class="calculate-btn w-full text-white font-semibold py-3 rounded-lg">
          Calculate Max Missable Hours
        </button>
      </div>

      <hr class="my-8 border-gray-200">

      <!-- Results Section -->
      <div id="results" class="space-y-4">
        <div class="flex justify-between items-center border-b pb-2">
          <h2 class="text-2xl font-semibold text-gray-800 dark:text-white">Results</h2>
          <button id="toggle-details-btn" onclick="toggleAdvancedDetails()"
            class="text-sm font-semibold text-blue-600 dark:text-gray-300 hover:text-blue-800 transition">
            Show Details
          </button>
        </div>

        <div id="summary-metrics" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
          <div class="md:col-span-1 flex flex-col items-center justify-center">
            <p class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Max Future Absences</p>
            <div id="max-drop-container"
              class="relative w-40 h-40 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg">
              <svg class="w-full h-full transform -rotate-90">
                <circle class="text-gray-200 dark:text-gray-700" stroke-width="12" stroke="currentColor"
                  fill="transparent" r="68" cx="80" cy="80" />
                <circle id="max-drop-circle" class="text-blue-500" stroke-width="12" stroke-dasharray="427"
                  stroke-dashoffset="427" stroke-linecap="round" stroke="currentColor" fill="transparent" r="68" cx="80"
                  cy="80" style="transition: stroke-dashoffset 0.8s ease-out;"></circle>
              </svg>
              <div class="absolute text-center">
                <span id="max-drop" class="text-6xl font-bold text-gray-800 dark:text-white">0</span>
                <p id="max-drop-weeks" class="text-xs text-gray-500 dark:text-gray-400 font-medium h-4 mt-1"></p>
              </div>
            </div>
          </div>

          <div class="md:col-span-2 grid grid-cols-2 gap-4 text-center">
            <div class="bg-gray-50 dark:bg-gray-800/50 py-2 px-4 rounded-lg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Attended</p>
              <p id="total-attended" class="text-4xl font-bold text-black-600 dark:text-white">0</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800/50 py-2 px-4 rounded-lg">
              <p class="text-sm text-gray-500 dark:text-gray-400">Total Conducted</p>
              <p id="total-conducted" class="text-4xl font-bold text-orange-600 dark:text-orange-400">0</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg col-span-2">
              <p class="text-sm text-gray-500 dark:text-gray-400">Current Percentage</p>
              <p id="current-percent" class="text-5xl font-bold text-gray-800 dark:text-gray-100">0.00%</p>
            </div>
          </div>
        </div>

        <div id="message-box" class="mt-6 p-4 rounded-lg text-center font-medium transition duration-300 hidden"
          role="alert"></div>

        <div id="error-message"
          class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden transition duration-300 ease-in-out">
        </div>


        <!-- Progress Graph -->
        <div class="pt-3 pb-10 px-0">
          <label class="block text-sm font-medium text-gray-700 dark:text-white mb-2">Attendance Progress</label>
          <div class="relative w-full bg-gray-200 rounded-full h-6 overflow-hidden">
            <div id="attendance-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
              class="absolute top-0 left-0 h-6 bg-green-500 text-white text-xs text-center leading-6 transition-all duration-300"
              style="width: 0%">0%</div>
            <div class="absolute top-0 h-6 border-l-2 border-red-500" id="target-marker" style="left: 65%;">
            </div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 dark:text-white mt-1">
            <span>0%</span>
            <span>Target</span>
            <span>100%</span>
          </div>
        </div>

        <!-- SUBJECT -->
        <div id="subject-breakdown-container" class="mt-10 hidden transition-all duration-500 ease-in-out">
          <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4 tracking-wide">
            📊 Subject-wise Breakdown
          </h3>

          <div class="overflow-x-auto rounded-lg shadow-lg">
            <table class="min-w-full text-sm text-gray-800 dark:text-gray-100 bg-white dark:bg-gray-800 rounded-lg">
              <thead>
                <tr
                  class="bg-gradient-to-r from-blue-100 to-blue-200 dark:from-blue-800 dark:to-blue-700 text-gray-700 dark:text-white uppercase text-xs tracking-wider">
                  <th class="px-6 py-4 text-left rounded-tl-lg">Subject Name</th>
                  <th class="px-6 py-4 text-center">Attended</th>
                  <th class="px-6 py-4 text-center">Conducted</th>
                  <th class="px-6 py-4 text-center rounded-tr-lg">Percentage</th>
                </tr>
              </thead>
              <tbody id="subject-breakdown-body" class="divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>


        <div id="subject-chart-container"
          class="mt-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 hidden">
          <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Attendance by Subject</h3>
          <div class="relative h-80"> <canvas id="subjectBarChart"></canvas>
          </div>
        </div>

        <!-- Custom Attendance Planner -->
        <div class="mt-6">
          <label for="custom-attend" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            What If I attend this many future classes:
          </label>
          <input type="number" id="custom-attend" class="w-full p-2 border rounded-lg mb-3"
            placeholder="Enter number of future classes to attend" min="0" oninput="calculateCustomMissable()">

          <div id="custom-missable-result" class="text-gray-800 dark:text-gray-100 font-medium mt-2 hidden"></div>
        </div>


      </div>

      <!-- Projection & Visuals Toggle -->
      <div class="mt-10">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-800 dark:text-white">Projection & Planner</h2>
          <button id="projection-tog" onclick="toggleProjection()"
            class="text-sm text-blue-600 dark:text-gray-300 hover:underline">
            Toggle View
          </button>
        </div>

        <div id="projection-container" class="mt-4 hidden">
          <div
            class="card bg-white/50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200/80 dark:border-gray-700/80 space-y-6">

            <div>
              <h3 class="font-bold text-lg mb-3 text-gray-700 dark:text-gray-200">🗓️ Set Your Timeline</h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Project by:</label>
                  <div class="flex gap-2 bg-gray-100 dark:bg-gray-900/50 p-1 rounded-full w-full max-w-xs shadow-inner">
                    <input type="radio" name="projectionMode" value="weeks" id="proj-mode-weeks"
                      class="hidden peer/weeks" checked onchange="updateDurationMode()" />
                    <label for="proj-mode-weeks"
                      class="flex-1 text-center peer-checked/weeks:bg-blue-600 peer-checked/weeks:text-white dark:text-gray-300 cursor-pointer px-3 py-1.5 text-sm rounded-full transition-colors duration-200">
                      Weeks
                    </label>
                    <input type="radio" name="projectionMode" value="days" id="proj-mode-days" class="hidden peer/days"
                      onchange="updateDurationMode()" />
                    <label for="proj-mode-days"
                      class="flex-1 text-center peer-checked/days:bg-blue-600 peer-checked/days:text-white dark:text-gray-300 cursor-pointer px-3 py-1.5 text-sm rounded-full transition-colors duration-200">
                      Days
                    </label>
                  </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <div>
                    <label id="remaining-time-label"
                      class="block text-sm font-medium text-gray-700 dark:text-white mb-1">Remaining
                      Weeks</label>
                    <input type="number" id="remaining-time" value="5" class="w-full p-2 border rounded-lg"
                      oninput="calculateHours()" min="1">
                  </div>
                  <div id="classes-per-week-container">
                    <label class="block text-sm font-medium text-gray-700 dark:text-white mb-1">Avg. Classes per
                      Week</label>
                    <input type="number" id="classes-per-week" value="30" class="w-full p-2 border rounded-lg"
                      oninput="calculateHours()" min="1">
                  </div>
                  <div id="days-per-week-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-white mb-1">Class Days per
                      Week</label>
                    <select id="days-per-week" class="w-full p-2 border rounded-lg" onchange="calculateHours()">
                      <option value="6">6 days</option>
                      <option value="5">5 days</option>
                      <option value="4">4 days</option>
                      <option value="3">3 days</option>
                      <option value="2">2 days</option>
                      <option value="1">1 day</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <hr class="border-gray-300 dark:border-gray-600/50">

            <div id="projection-output" class="hidden">
              <h3 class="font-bold text-lg mb-4 text-gray-700 dark:text-gray-200">📈 Your Projection</h3>
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                <div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Remaining Classes</p>
                  <p id="total-remaining-classes" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Must Attend</p>
                  <p id="required-attendance" class="text-3xl font-bold text-green-600 dark:text-green-400">0</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Can Skip</p>
                  <p id="allowed-skips" class="text-3xl font-bold text-yellow-600 dark:text-yellow-400">0</p>
                </div>
                <div class="bg-gray-100 dark:bg-gray-900/50 p-4 rounded-lg col-span-2 lg:col-span-1">
                  <p class="text-sm text-gray-500 dark:text-gray-400">Final %</p>
                  <p id="projected-percent" class="text-3xl font-bold">0.00%</p>
                </div>
              </div>
            </div>
          </div>


          <div class="mt-10">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-100">🏖️ Holiday & Leave Planner</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1 mb-4">
              Plan for upcoming leaves by simulating classes attended beforehand and calculating the impact.
            </p>
            <div
              class="card bg-white/50 dark:bg-gray-800/50 p-6 rounded-xl border border-gray-200/80 dark:border-gray-700/80 space-y-4">

              <div>
                <label for="attend-before-leave"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Classes to Attend <span class="font-bold">Before</span> Leave?
                </label>
                <input type="number" id="attend-before-leave" class="w-full p-2 border rounded-lg"
                  placeholder="Enter 0 if leaving immediately" min="0" value="0">
              </div>

              <hr class="border-gray-200 dark:border-gray-600">

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">How do you want to
                  measure
                  your leave?</label>
                <div class="flex gap-2 bg-gray-100 dark:bg-gray-900/50 p-1 rounded-full w-full max-w-xs shadow-inner">
                  <input type="radio" name="holidayInputMode" value="days" id="mode-days" class="hidden peer/days"
                    checked />
                  <label for="mode-days"
                    class="flex-1 text-center peer-checked/days:bg-blue-600 peer-checked/days:text-white dark:text-gray-300 cursor-pointer px-3 py-1.5 text-sm rounded-full transition-colors duration-200">
                    By Days
                  </label>

                  <input type="radio" name="holidayInputMode" value="classes" id="mode-classes"
                    class="hidden peer/classes" />
                  <label for="mode-classes"
                    class="flex-1 text-center peer-checked/classes:bg-blue-600 peer-checked/classes:text-white dark:text-gray-300 cursor-pointer px-3 py-1.5 text-sm rounded-full transition-colors duration-200">
                    By Classes
                  </label>
                </div>
              </div>

              <div id="holiday-input-days" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label for="holiday-days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    How many days of leave?
                  </label>
                  <input type="number" id="holiday-days" class="w-full p-2 border rounded-lg" placeholder="e.g., 5"
                    min="1">
                </div>
                <div>
                  <label for="classes-per-holiday-day"
                    class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                    Avg. Classes per Day
                  </label>
                  <input type="number" id="classes-per-holiday-day" class="w-full p-2 border rounded-lg"
                    placeholder="e.g., 4" min="1">
                </div>
              </div>

              <div id="holiday-input-classes" class="hidden">
                <label for="total-missed-classes"
                  class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                  Total Classes to Miss
                </label>
                <input type="number" id="total-missed-classes" class="w-full p-2 border rounded-lg"
                  placeholder="e.g., 20" min="1">
              </div>

              <button onclick="calculateHolidayImpact()"
                class="calculate-btn w-full text-white font-semibold py-3 rounded-lg">
                Analyze Holiday Impact
              </button>

              <div id="holiday-impact-result"
                class="mt-4 p-4 rounded-lg text-align-left font-medium transition duration-300 hidden" role="alert">
              </div>
            </div>
          </div>
        </div>
      </div>


      <hr class="py-5 mt-6 w-[45dvw] mx-auto">

      <div class="mt-6">
        <label class="block font-semibold mb-2 dark:text-gray-400">What would you like on arrival?</label>
        <div class="flex justify-between bg-gray-100 dark:bg-gray-700 p-1 rounded-full w-full max-w-full shadow-inner">

          <input type="radio" name="loadOption" value="resume" id="resume" class="hidden peer/resume" />
          <label for="resume"
            class="peer-checked/resume:bg-blue-600 peer-checked/resume:text-white dark:text-gray-400 cursor-pointer px-4 py-2 text-sm rounded-full transition-colors duration-200">
            Resume Last Save
          </label>

          <input type="radio" name="loadOption" value="clipboard" id="clipboard" class="hidden peer/clipboard" />
          <label for="clipboard"
            class="peer-checked/clipboard:bg-blue-600 peer-checked/clipboard:text-white dark:text-gray-400 cursor-pointer px-4 py-2 text-sm rounded-full transition-colors duration-200">
            Paste from Clipboard
          </label>

          <input type="radio" name="loadOption" value="none" id="none" class="hidden peer/none" />
          <label for="none"
            class="peer-checked/none:bg-blue-600 peer-checked/none:text-white dark:text-gray-400 cursor-pointer px-4 py-2 text-sm rounded-full transition-colors duration-200">
            Do Nothing
          </label>

        </div>
      </div>


      <div class="mt-6 flex items-center justify-between">
        <label for="show-overlay-toggle" class="text-sm font-medium text-gray-700 dark:text-gray-300">
          Show attendance alert popup?
        </label>

        <input type="checkbox" id="show-overlay-toggle" class="toggle-checkbox hidden" />
        <label for="show-overlay-toggle"
          class="toggle-label relative inline-block w-12 h-6 bg-gray-300 rounded-full cursor-pointer transition">
          <span
            class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow-md transform transition-transform"></span>
        </label>
      </div>

      <div id="overall-chart-container"
        class="mt-8 p-6 bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 hidden">
        <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Overall Attendance Breakdown</h3>
        <div class="relative h-64 w-64 mx-auto"> <canvas id="overallDonutChart"></canvas>
        </div>
      </div>


    </div>
    <div class="related-articles reveal">
      <h3 class="section-title">Go Deeper into the Alchemy</h3>
      <div class="articles-grid">
        <a href="./attendance-drop-calculator/polymorphs.html" class="article-card">
          <div class="article-card-content">
            <span class="article-category">Code & Craft</span>
            <h4>How Different Styles of the Same Calculator Function Can Look</h4>
            <p>Explore three versions of the core attendance logic in JavaScript, from a simple function to a robust,
              object-oriented approach. See how code evolves for clarity and power.</p>
            <span class="read-more">Read Article <span class="arrow">&rarr;</span></span>
          </div>
        </a>
        <a href="./attendance-drop-calculator/psychology-of-skipping.html" class="article-card">
          <div class="article-card-content">
            <span class="article-category">Strategy</span>
            <h4>The Psychology of 'Just One More Skip'</h4>
            <p>Learn how to manage your attendance buffer like a resource and avoid the common pitfalls that lead to
              last-minute panic.</p>
            <span class="read-more">Read Article <span class="arrow">&rarr;</span></span>
          </div>
        </a>
        <a href="./attendance-drop-calculator/understanding-policies.html" class="article-card">
          <div class="article-card-content">
            <span class="article-category">Productivity</span>
            <h4>Is 75% the Magic Number? Understanding Attendance Policies</h4>
            <p>A breakdown of why attendance policies exist and how to navigate them successfully throughout your
              academic career.</p>
            <span class="read-more">Read Article <span class="arrow">&rarr;</span></span>
          </div>
        </a>
      </div>
    </div>
  </div>

  <!-- Max Drop Overlay -->
  <div id="max-drop-overlay"
    class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-end justify-center hidden">
    <div id="max-drop-card"
      class="w-full max-w-lg bg-white dark:bg-black rounded-t-3xl shadow-xl transition-transform duration-500 ease-[cubic-bezier(0.34,1.56,0.64,1)] translate-y-full border-t-2 border-gray-200 dark:border-gray-700">
      <div class="w-16 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mt-3"></div>
      <div class="text-center p-6">
        <div id="lottie-container" class="w-28 h-28 mx-auto mb-2"></div>
        <h2 class="text-3xl font-bold mb-2" id="max-drop-message">Calculating...</h2>
        <p class="text-gray-600 dark:text-gray-400 text-lg mt-2" id="max-drop-details">Please wait...</p>
        <button onclick="dismissMaxDropOverlay()"
          class="mt-8 bg-blue-600 text-white font-semibold px-8 py-3 rounded-full shadow-lg hover:bg-blue-700 hover:scale-105 active:scale-95 transition-all duration-200">
          Got it!
        </button>
      </div>
    </div>
  </div>

  <button id="toggle-sticky-message-fab"
    class="hidden fixed bottom-2 right-3 sm:bottom-5 sm:right-5 z-40 w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all duration-300 transform hover:scale-110 active:scale-95">

    <svg id="fab-icon-show" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24"
      stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 12.5C8 16.5, 16 16.5, 19 12.5" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M8.5 15 L 7 17" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 15.5 L 12 17.5" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15.5 15 L 17 17" />
    </svg>

    <svg id="fab-icon-hide" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 hidden" fill="none" viewBox="0 0 24 24"
      stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round"
        d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </svg>

  </button>


  <div id="toast"
    class="fixed top-5 right-5 z-50 hidden items-center gap-2 rounded-lg bg-black px-4 py-2 text-white shadow-md transition-opacity duration-300">
    ✅ Progress restored automatically.
  </div>

  <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
  <script>

    const cursor = document.querySelector('.cursor');
    const cursorGlow = document.querySelector('.cursor-glow');

    document.addEventListener('mousemove', (e) => {
      // This instantly moves the custom cursor to the real pointer's location
      if (cursor) {
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
      }
      if (cursorGlow) {
        cursorGlow.style.left = e.clientX + 'px';
        cursorGlow.style.top = e.clientY + 'px';
      }
    });

    document.querySelectorAll('button, a, input, select, [data-tooltip]').forEach(el => {
      el.addEventListener('mouseenter', () => cursor.classList.add('active'));
      el.addEventListener('mouseleave', () => cursor.classList.remove('active'));
    });

    document.addEventListener('DOMContentLoaded', () => {
      const tour = new Shepherd.Tour({
        useModalOverlay: true, // This darkens the background
        defaultStepOptions: {
          classes: 'shadow-md bg-white dark:bg-gray-800',
          scrollTo: { behavior: 'smooth', block: 'center' }
        }
      });

      // Define the steps of your tour
      tour.addStep({
        id: 'step-1-data',
        text: "Welcome to Attendance Calc (by Thingdom)! You can start by droping your attendance report here. You can drop the csv or xlsx file. OR",
        attachTo: { element: '#dropzone', on: 'bottom' },
        buttons: [
          {
            text: 'Next',
            action: tour.next
          }
        ]
      });

      tour.addStep({
        id: 'step-2-paste',
        text: 'Clicking here you can paste your attendance data here(raw logs or aggregated data).',
        attachTo: { element: '#paste-btn', on: 'bottom' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      tour.addStep({
        id: 'step-3-target',
        text: 'Set your required attendance percentage here. The default is 65%.',
        attachTo: { element: '#target-percent', on: 'bottom' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      tour.addStep({
        id: 'step-4-results',
        text: 'Your results will appear here instantly, showing your current % and how many classes you can afford to miss.',
        attachTo: { element: '#summary-metrics', on: 'bottom' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      tour.addStep({
        id: 'step-5-details',
        text: 'Click here to see a detailed, subject-by-subject breakdown of your attendance.',
        attachTo: { element: '#toggle-details-btn', on: 'top' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      tour.addStep({
        id: 'step-6-projection',
        text: 'Finally, explore the "Future Projection" tool to plan for the rest of your semester!',
        attachTo: { element: '#projection-tog', on: 'top' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Done!', action: tour.complete }
        ]
      });

      tour.addStep({
        id: 'step-7-onarrival',
        text: "On arrival what would like to happen automatically (eg. paste will paste what have copied automatically so that you don't have to click on paste button everytime).",
        attachTo: { element: '#clipboard', on: 'top' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      tour.addStep({
        id: 'step-8-quickpopup',
        text: "Here you can disable this if you don't wanna see the popup ever.",
        attachTo: { element: '#show-overlay-toggle', on: 'top' },
        buttons: [
          { text: 'Back', secondary: true, action: tour.back },
          { text: 'Next', action: tour.next }
        ]
      });

      // --- Logic to only show the tour once ---
      function startTour() {
        // If the tour is completed, don't start it.
        if (localStorage.getItem('attendanceAppTourCompleted')) {
          return;
        }
        tour.start();
      }

      // When the tour is finished, mark it as completed
      tour.on('complete', () => {
        localStorage.setItem('attendanceAppTourCompleted', 'true');
      });

      // If the user cancels, also mark it as completed so it doesn't reappear
      tour.on('cancel', () => {
        localStorage.setItem('attendanceAppTourCompleted', 'true');
      });

      // Start the tour
      startTour();

      // (Optional) Add a button somewhere to let users restart the tour
      const helpButton = document.getElementById('restart-tour-btn'); // You would need to create this button
      if (helpButton) {
        helpButton.addEventListener('click', () => {
          localStorage.removeItem('attendanceAppTourCompleted'); // Clear the flag
          tour.start();
        });
      }
    });

    // GENIE MESS
    let isStickyManuallyHidden = false;
    let stickyTimeout = null;

    // Helper function to show the sticky bar
    function showStickyBar(sourceElement) {
      const stickyBar = document.getElementById('sticky-message-bar');
      const stickyContent = document.getElementById('sticky-message-content');

      // Copy content and styling
      stickyContent.innerHTML = sourceElement.innerHTML;
      stickyContent.className = sourceElement.className;
      stickyContent.classList.remove('hidden', 'mt-6', 'mt-4');

      // Animate into view
      stickyBar.classList.remove('hidden', 'genie-hide');
      setTimeout(() => {
        stickyContent.classList.remove('-translate-y-20', 'opacity-0');
      }, 10);
    }

    // Helper function to hide the sticky bar
    function hideStickyBar() {
      const stickyBar = document.getElementById('sticky-message-bar');
      const stickyContent = document.getElementById('sticky-message-content');
      stickyContent.classList.add('-translate-y-20', 'opacity-0');
      // Use a timeout to hide the element after the animation, preventing flicker
      if (stickyTimeout) clearTimeout(stickyTimeout);
      stickyTimeout = setTimeout(() => {
        stickyBar.classList.add('hidden');
      }, 300);
    }

    // Main function to check the state and update UI
    function checkStickyState() {
      const messageBox = document.getElementById('message-box');
      const errorBox = document.getElementById('error-message');
      const fab = document.getElementById('toggle-sticky-message-fab');

      const activeMessage = !messageBox.classList.contains('hidden') ? messageBox :
        !errorBox.classList.contains('hidden') ? errorBox : null;

      if (!activeMessage) {
        hideStickyBar();
        fab.classList.add('hidden');
        return;
      }

      const rect = activeMessage.getBoundingClientRect();
      // const isInViewport = rect.top >= 0 && rect.bottom <= (window.innerHeight || document.documentElement.clientHeight);

      // if (isInViewport) {
      //   hideStickyBar();
      //   fab.classList.add('hidden');
      // } else {
      //   fab.classList.remove('hidden');
      //   if (isStickyManuallyHidden) {
      //     document.getElementById('sticky-message-bar').classList.add('genie-hide');
      //     hideStickyBar();
      //   } else {
      //     showStickyBar(activeMessage);
      //   }
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight;

      // --- LOGIC CHANGE IS HERE ---
      // Calculate how much of the element is vertically visible in pixels.
      const visibleHeight = Math.max(0, Math.min(rect.bottom, viewportHeight) - Math.max(rect.top, 0));

      // Check if that visible height is at least 10% of the element's total height.
      const isSufficientlyInViewport = (visibleHeight / rect.height) >= 0.35;
      // --- END OF LOGIC CHANGE ---

      if (isSufficientlyInViewport) {
        // If it's sufficiently in view, hide the sticky bar and the FAB.
        hideStickyBar();
        fab.classList.add('hidden');
      } else {
        // If it's mostly out of view, show the FAB.
        fab.classList.remove('hidden');
        // And show/hide the sticky bar based on the manual toggle.
        if (isStickyManuallyHidden) {
          document.getElementById('sticky-message-bar').classList.add('genie-hide');
          hideStickyBar();
        } else {
          showStickyBar(activeMessage);
        }
      }
    }

    // Listen for clicks on the new Floating Action Button
    document.getElementById('toggle-sticky-message-fab').addEventListener('click', () => {
      isStickyManuallyHidden = !isStickyManuallyHidden;
      const fab = document.getElementById('toggle-sticky-message-fab');
      fab.classList.toggle('active', isStickyManuallyHidden);
      document.getElementById('fab-icon-show').classList.toggle('hidden', !isStickyManuallyHidden);
      document.getElementById('fab-icon-hide').classList.toggle('hidden', isStickyManuallyHidden);
      checkStickyState(); // Re-evaluate the state immediately
    });

    // Throttle scroll events for better performance
    let scrollTimeout;
    window.addEventListener('scroll', () => {
      if (scrollTimeout) return;
      scrollTimeout = setTimeout(() => {
        checkStickyState();
        scrollTimeout = null;
      }, 150);
    });
  </script>

  <script>
    let lottieAnimation;

    document.getElementById('data-input').addEventListener('input', calculateHours);

    function showMessage(type, text) {
      const messageBox = document.getElementById('message-box');
      messageBox.innerHTML = text;
      messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');

      if (type === 'success') {
        messageBox.classList.add('bg-green-100', 'text-green-700');
      } else if (type === 'error') {
        messageBox.classList.add('bg-red-100', 'text-red-700');
      }
      setTimeout(checkStickyState, 0);
    }

    function aggregateRawLogData(allLines) {
      // 1. Try to find the actual header line
      let startIndex = 0;
      let headers = [];

      for (let i = 0; i < allLines.length; i++) {
        const line = allLines[i].trim();
        const lowerLine = line.toLowerCase();

        if (lowerLine.includes('marked') && lowerLine.includes('number of hours')) {
          headers = line.split(/\t| {2,}/).map(h => h.trim()).filter(Boolean);
          startIndex = i;
          break;
        }
      }

      if (headers.length === 0) {
        return null; // couldn't find the header line
      }

      const markedIndex = headers.findIndex(h => h.toLowerCase().includes('marked'));
      const hoursIndex = headers.findIndex(h => h.toLowerCase().includes('number of hours'));
      const subjectIndex = headers.findIndex(h => h.toLowerCase().includes('subject'));

      if (markedIndex === -1 || hoursIndex === -1 || subjectIndex === -1) {
        return null; // required columns missing
      }

      const subjectStats = {};
      const dataLines = allLines.slice(startIndex + 1);

      for (const line of dataLines) {
        const values = line.split(/\t| {2,}/).map(v => v.trim()).filter(Boolean);
        if (values.length <= Math.max(markedIndex, hoursIndex, subjectIndex)) continue;

        const subject = values[subjectIndex];
        const marked = values[markedIndex].toUpperCase();
        const hours = parseFloat(values[hoursIndex]) || 0;

        if (!subjectStats[subject]) {
          subjectStats[subject] = { Present: 0, OD: 0, Absent: 0 };
        }

        if (marked === 'P') subjectStats[subject].Present += hours;
        else if (marked === 'OD') subjectStats[subject].OD += hours;
        else if (marked === 'A') subjectStats[subject].Absent += hours;
      }

      // Rebuild aggregated data table
      const rebuiltLines = ["#\tSubject\tPresent\tOD\tAbsent"];
      let counter = 1;
      for (const subject in subjectStats) {
        const s = subjectStats[subject];
        rebuiltLines.push(`${counter++}\t${subject}\t${s.Present}\t${s.OD}\t${s.Absent}`);
      }

      return rebuiltLines.join('\n');
    }



    function calculateHours() {
      const dataInput = document.getElementById('data-input').value.trim();
      const targetPercentInput = document.getElementById('target-percent').value;
      const errorElement = document.getElementById('error-message');
      const resultElements = {
        attended: document.getElementById('total-attended'),
        conducted: document.getElementById('total-conducted'),
        current: document.getElementById('current-percent'),
        drop: document.getElementById('max-drop')
      };

      // --- UI & Chart Reset ---
      const overallChartContainer = document.getElementById('overall-chart-container');
      const subjectChartContainer = document.getElementById('subject-chart-container');
      if (window.overallDonutChartInstance) window.overallDonutChartInstance.destroy();
      if (window.subjectBarChartInstance) window.subjectBarChartInstance.destroy();
      if (overallChartContainer) overallChartContainer.classList.add('hidden');
      if (subjectChartContainer) subjectChartContainer.classList.add('hidden');
      errorElement.classList.add('hidden');
      document.getElementById('message-box').classList.add('hidden');
      setTimeout(checkStickyState, 0);

      // Find this block at the start of calculateHours()
      if (!dataInput) {

        showError('Please provide attendance data to begin the calculation.');
        document.getElementById('results').classList.remove('hidden');

        resultElements.attended.textContent = '0';
        resultElements.conducted.textContent = '0';
        resultElements.drop.textContent = '0';
        resultElements.current.textContent = '0.00%';
        const currentPercentEl = resultElements.current;
        currentPercentEl.classList.remove('text-green-500', 'text-red-600');
        currentPercentEl.classList.add('text-gray-800', 'dark:text-gray-100');
        const circle = document.getElementById('max-drop-circle');
        const dropContainer = document.getElementById('max-drop-container');
        const maxDropWeeksEl = document.getElementById('max-drop-weeks');

        if (circle) {
          circle.style.strokeDashoffset = 427; // New circumference for larger circle
          circle.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500');
        }
        if (maxDropWeeksEl) maxDropWeeksEl.textContent = ''; // Clear weeks text

        if (dropContainer) {
          // Reset container classes to default state
          dropContainer.className = 'relative w-40 h-40 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg';
        }
        return;
      }

      const targetPercentage = parseFloat(targetPercentInput) / 100;
      if (isNaN(targetPercentage) || targetPercentage <= 0 || targetPercentage > 1) {
        errorElement.textContent = 'Invalid Target Percentage. Must be between 1 and 100.';
        errorElement.classList.remove('hidden');
        return;
      }

      // --- Data Parsing & Header Detection ---
      const lines = dataInput.split('\n').filter(line => line.trim() !== '');
      let startRowIndex = -1;
      for (let i = 0; i < lines.length; i++) {
        const headerLine = lines[i].trim().toLowerCase();
        if (headerLine.includes('subject') && headerLine.includes('present') && (headerLine.includes('od') || headerLine.includes('duty')) && headerLine.includes('absent')) {
          startRowIndex = i;
          break;
        }
      }

      const isRawLogFormat = lines.some(line => line.toLowerCase().includes('marked') && line.toLowerCase().includes('number of hours'));
      if (startRowIndex === -1 && isRawLogFormat) {
        const aggregatedData = aggregateRawLogData(lines);
        if (aggregatedData) {
          document.getElementById('data-input').value = aggregatedData;
          showToast("📋 Raw log data detected and auto-formatted.");
          setTimeout(() => calculateHours(), 0);
          return;
        }
      }

      if (startRowIndex === -1) {
        errorElement.textContent = 'Could not find a valid header row containing "Subject", "Present", "OD", and "Absent".';
        errorElement.classList.remove('hidden');
        return;
      }

      const validLines = lines.slice(startRowIndex);
      const headerLine = validLines[0];

      // Detect the primary separator (comma OR tab/spaces) from the header
      let separator = headerLine.includes(',') ? ',' : /\t| {2,}/;

      const headers = headerLine.split(separator).map(h => h.trim().replace(/"/g, ''));
      const normalizedHeaders = headers.map(h => h.toLowerCase());

      // const presentIndex = headers.findIndex(h => h.toLowerCase().includes('present'));
      // const odIndex = headers.findIndex(h => h.toLowerCase() === 'od' || h.toLowerCase().includes('duty'));
      // const absentIndex = headers.findIndex(h => h.toLowerCase().includes('absent'));
      // const subjectIndex = headers.findIndex(h => h.toLowerCase().includes('subject'));

      const presentIndex = normalizedHeaders.findIndex(h => h.includes('present'));
      const odIndex = normalizedHeaders.findIndex(h => h === 'od' || h.includes('duty'));
      const absentIndex = normalizedHeaders.findIndex(h => h.includes('absent'));
      const subjectIndex = normalizedHeaders.findIndex(h => h.includes('subject'));


      if (presentIndex === -1 || odIndex === -1 || absentIndex === -1 || subjectIndex === -1) {
        errorElement.textContent = 'Could not find required columns: "Subject", "Present", "OD", and "Absent".';
        errorElement.classList.remove('hidden');
        return;
      }

      // --- UNIFIED AGGREGATION LOGIC ---
      let subjectStats = {};
      for (let i = 1; i < validLines.length; i++) {
        let subjectName = "Unknown Subject";
        let presentVal = 0, odVal = 0, absentVal = 0;

        // --- DUAL PARSING STRATEGY ---
        // Strategy 1: Check for the "Detailed Log" format first.
        // This format is ONLY valid when the main separator is TABS/SPACES.
        if (separator !== ',' && validLines[i].includes(',')) {
          const tabSeparatedValues = validLines[i].split(/\t| {2,}/).map(v => v.trim());

          if (tabSeparatedValues.length > subjectIndex) {
            const outerPresent = parseFloat(tabSeparatedValues[presentIndex]) || 0;
            const outerOD = parseFloat(tabSeparatedValues[odIndex]) || 0;
            const outerAbsent = parseFloat(tabSeparatedValues[absentIndex]) || 0;
            const subjectField = tabSeparatedValues[subjectIndex];

            if (outerPresent === 0 && outerOD === 0 && outerAbsent === 0) {
              const innerValues = subjectField.split(',').map(v => v.trim().replace(/"/g, ''));
              if (innerValues.length > 2) {
                subjectName = innerValues[2] || "Detailed Log Subject";
                const status = innerValues[innerValues.length - 1].toUpperCase().trim();
                const hours = parseFloat(innerValues[innerValues.length - 2]) || 0;

                if (status === 'P') presentVal = hours;
                else if (status === 'OD') odVal = hours;
                else if (status === 'A') absentVal = hours;
              }
            } else { // It's a normal tab-separated row
              subjectName = subjectField.replace(/"/g, '') || "Unknown Subject";
              presentVal = outerPresent;
              odVal = outerOD;
              absentVal = outerAbsent;
            }
          }
        }
        // Strategy 2: Fallback to the standard aggregated format (for both CSV and regular Tab/Space data)
        else {
          const rowValues = validLines[i].split(separator).map(v => v.trim().replace(/"/g, ''));
          if (rowValues.length > Math.max(presentIndex, odIndex, absentIndex, subjectIndex)) {
            subjectName = rowValues[subjectIndex] || "Unknown Subject";
            presentVal = parseFloat(rowValues[presentIndex]) || 0;
            odVal = parseFloat(rowValues[odIndex]) || 0;
            absentVal = parseFloat(rowValues[absentIndex]) || 0;
          }
        }

        const attended = presentVal + odVal;
        const conducted = presentVal + odVal + absentVal;

        if (conducted > 0) {
          if (!subjectStats[subjectName]) {
            subjectStats[subjectName] = { attended: 0, conducted: 0, present: 0, od: 0, absent: 0 };
          }
          subjectStats[subjectName].attended += attended;
          subjectStats[subjectName].conducted += conducted;
          subjectStats[subjectName].present += presentVal;
          subjectStats[subjectName].od += odVal;
          subjectStats[subjectName].absent += absentVal;
        }
      }

      // --- The rest of the function remains the same ---
      let totalAttended = 0, totalConductableClasses = 0, totalPresent = 0, totalOD = 0, totalAbsent = 0;
      for (const subject in subjectStats) {
        totalAttended += subjectStats[subject].attended;
        totalConductableClasses += subjectStats[subject].conducted;
        totalPresent += subjectStats[subject].present;
        totalOD += subjectStats[subject].od;
        totalAbsent += subjectStats[subject].absent;
      }

      if (totalConductableClasses === 0) {
        errorElement.textContent = 'No valid numeric attendance data could be aggregated from the rows.';
        errorElement.classList.remove('hidden');
        return;
      }

      displaySubjectBreakdown(subjectStats, targetPercentage * 100);
      drawOverallDonutChart(totalPresent, totalOD, totalAbsent);
      drawSubjectBarChart(subjectStats, targetPercentage * 100);

      const numerator = totalAttended - (targetPercentage * totalConductableClasses);
      const maxDropFloat = numerator / targetPercentage;
      let maxDrop = Math.floor(maxDropFloat);
      let requiredClasses = 0;

      if (maxDrop < 0) {
        maxDrop = 0;
        requiredClasses = Math.ceil((targetPercentage * totalConductableClasses - totalAttended) / (1 - targetPercentage));
        const newAttended = totalAttended + requiredClasses;
        const newConducted = totalConductableClasses + requiredClasses;
        const afterPercentage = (newAttended / newConducted) * 100;
        showMessage(
          'error',
          `👉 You must attend at least <strong>${requiredClasses}</strong> more classes consecutively (without missing) to reach <strong>${afterPercentage.toFixed(2)}%</strong> attendance.`
        );
      } else {
        const newTotalConducted = totalConductableClasses + maxDrop;
        const resultingPercent = (totalAttended / newTotalConducted) * 100;
        showMessage('success', `You're on track! You can afford to miss <strong>${maxDrop}</strong> more hours and your attendance will still be <strong>${resultingPercent.toFixed(2)}%</strong>.`);
      }

      if (!isNaN(maxDrop)) {
        showMaxDropOverlay(maxDrop, requiredClasses);
      }

      const currentAttended = parseInt(resultElements.attended.textContent) || 0;
      const currentConducted = parseInt(resultElements.conducted.textContent) || 0;
      const currentDrop = parseInt(resultElements.drop.textContent) || 0;
      const currentPercentage = (totalAttended / totalConductableClasses) * 100;

      animateValue(resultElements.attended, currentAttended, totalAttended, 800);
      animateValue(resultElements.conducted, currentConducted, totalConductableClasses, 800);
      animateValue(resultElements.drop, currentDrop, maxDrop, 800);
      resultElements.current.textContent = `${currentPercentage.toFixed(2)}%`;

      const circle = document.getElementById('max-drop-circle');
      const dropContainer = document.getElementById('max-drop-container');
      const maxDropWeeksEl = document.getElementById('max-drop-weeks');
      const circumference = 427; // Updated from 364 for the new radius

      // Explicitly set offset to full to ensure it's empty when <= 0
      if (maxDrop <= 0) {
        circle.style.strokeDashoffset = circumference;
      } else {
        // Normalize progress: 25+ absences = full circle.
        const progress = Math.min(maxDrop / 25, 1);
        const offset = circumference - progress * circumference;
        if (circle) circle.style.strokeDashoffset = offset;
      }

      // Update the "~ weeks" text based on projection planner input
      const classesPWeek = parseInt(document.getElementById('classes-per-week')?.value) || 0;
      if (classesPWeek > 0 && maxDrop > 0) {
        const weeksApproximation = maxDrop / classesPWeek;
        maxDropWeeksEl.textContent = `~ ${weeksApproximation.toFixed(1)} weeks`;
      } else {
        maxDropWeeksEl.textContent = ''; // Clear text if no data
      }

      if (dropContainer) {
        // Reset classes to base and add shadow
        dropContainer.className = 'relative w-40 h-40 rounded-full flex items-center justify-center transition-all duration-300 shadow-lg';
        circle.classList.remove('text-green-500', 'text-yellow-500', 'text-red-500');
        const currentPercentEl = resultElements.current;

        // Remove ALL potential color classes to prevent conflicts
        currentPercentEl.classList.remove(
          'text-gray-800',
          'dark:text-gray-100',
          'text-green-500',
          'text-red-600'
        );

        // Add ONLY the correct dynamic color
        if (currentPercentage >= targetPercentage * 100) {
          currentPercentEl.classList.add('text-green-500');
        } else {
          currentPercentEl.classList.add('text-red-600');
        }

        if (maxDrop >= 10) {
          dropContainer.classList.add('bg-green-100', 'dark:bg-green-500/10');
          circle.classList.add('text-green-500');
        } else if (maxDrop > 0) {
          dropContainer.classList.add('bg-yellow-100', 'dark:bg-yellow-500/10');
          circle.classList.add('text-yellow-500');
          // Add warning pulse for low number of skips
          if (maxDrop < 10) {
            dropContainer.classList.add('pulse-warning-animation');
          }
        } else {
          dropContainer.classList.add('bg-red-100', 'dark:bg-red-500/10');
          circle.classList.add('text-red-500');
        }
      }

      // --- Future Projection Logic ---
      const durationType = document.querySelector('input[name="projectionMode"]:checked')?.value || 'weeks';
      const remainingTime = parseInt(document.getElementById('remaining-time')?.value) || 0;
      const classesPerWeek = parseInt(document.getElementById('classes-per-week')?.value) || 0;
      let totalRemainingClasses = 0;

      // Calculate total remaining classes
      if (durationType === 'weeks') {
        totalRemainingClasses = remainingTime * classesPerWeek;
      } else if (durationType === 'days') {
        const daysPerWeek = parseInt(document.getElementById('days-per-week')?.value) || 0;
        if (daysPerWeek > 0) {
          const avgClassesPerDay = classesPerWeek / daysPerWeek;
          totalRemainingClasses = Math.round(remainingTime * avgClassesPerDay);
        }
      }

      const projectionOutput = document.getElementById('projection-output');

      if (remainingTime > 0 && classesPerWeek > 0) {
        const totalRequiredAttendance = Math.ceil((totalConductableClasses + totalRemainingClasses) * targetPercentage);
        const classesNeededToAttend = Math.max(0, totalRequiredAttendance - totalAttended);
        const possibleSkips = Math.max(0, totalRemainingClasses - classesNeededToAttend);

        // Determine if the student can reach the target
        const canReachTarget = classesNeededToAttend <= totalRemainingClasses;

        let finalAttended, finalConducted;

        if (canReachTarget) {
          // Case 1: Can reach target — assume student attends only required classes
          finalAttended = totalAttended + classesNeededToAttend;
        } else {
          // Case 2: Cannot reach target — assume they attend all remaining classes
          finalAttended = totalAttended + totalRemainingClasses;
        }

        // Total conducted includes all remaining classes
        finalConducted = totalConductableClasses + totalRemainingClasses;

        const projectedPercentage = finalConducted > 0
          ? ((finalAttended / finalConducted) * 100).toFixed(2)
          : "0.00";

        const projectedPercentEl = document.getElementById('projected-percent');
        projectedPercentEl.textContent = `${projectedPercentage}%`;

        // Color coding
        projectedPercentEl.classList.remove('text-green-500', 'text-red-500', 'dark:text-green-400', 'dark:text-red-400');
        if (parseFloat(projectedPercentage) >= targetPercentage * 100) {
          projectedPercentEl.classList.add('text-green-500', 'dark:text-green-400');
        } else {
          projectedPercentEl.classList.add('text-red-500', 'dark:text-red-400');
        }

        // Check if it's even possible to reach the target
        const maxPossibleAttended = totalAttended + totalRemainingClasses;
        const maxPossiblePercent = (maxPossibleAttended / finalConducted) * 100;

        if (!canReachTarget) {
          showMessage(
            'error',
            `⚠️ Even if you attend all remaining ${totalRemainingClasses} classes, your attendance will be only <strong>${projectedPercentage}%</strong>. You cannot reach the target of <strong>${(targetPercentage * 100).toFixed(2)}%</strong>.`
          );
        } else if (maxPossiblePercent < targetPercentage * 100) {
          showMessage(
            'error',
            `⚠️ Even if you attend all remaining ${totalRemainingClasses} classes, your max attendance will be <strong>${maxPossiblePercent.toFixed(2)}%</strong>.`
          );
        }

        // Update UI
        projectionOutput.classList.remove('hidden');
        document.getElementById('total-remaining-classes').textContent = totalRemainingClasses;
        document.getElementById('required-attendance').textContent = classesNeededToAttend;
        document.getElementById('allowed-skips').textContent = possibleSkips;

      } else {
        projectionOutput.classList.add('hidden');
      }

      // --- Progress Bar Update ---
      const progressBar = document.getElementById('attendance-bar');
      const marker = document.getElementById('target-marker');
      const currentPercent = (totalAttended / totalConductableClasses) * 100;
      progressBar.setAttribute('aria-valuenow', currentPercent.toFixed(1));
      const targetPercentValue = targetPercentage * 100;
      progressBar.style.width = `${Math.min(currentPercent, 100)}%`;
      progressBar.textContent = `${currentPercent.toFixed(1)}%`;
      progressBar.classList.remove('bg-green-500', 'bg-red-500');
      progressBar.classList.add(currentPercent >= targetPercentValue ? 'bg-green-500' : 'bg-red-500');
      marker.style.left = `${targetPercentValue}%`;
    }

    function displaySubjectBreakdown(subjectStats, targetPercent) {
      const container = document.getElementById('subject-breakdown-container');
      const tableBody = document.getElementById('subject-breakdown-body');
      tableBody.innerHTML = '';

      if (Object.keys(subjectStats).length === 0) {
        container.classList.add('hidden');
        return;
      }

      const sortedSubjects = Object.keys(subjectStats).sort();

      for (const subjectName of sortedSubjects) {
        const stats = subjectStats[subjectName];
        if (stats.conducted === 0) continue;
        const percentage = (stats.attended / stats.conducted) * 100;
        const textColorClass = percentage >= targetPercent ? 'text-green-600 dark:text-green-300' : 'text-red-600';
        const row = `
                <tr>
                    <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-gray-200">${subjectName}</td>
                    <td class="px-4 py-2 text-center text-sm text-gray-600 dark:text-gray-400">${stats.attended}</td>
                    <td class="px-4 py-2 text-center text-sm text-gray-600 dark:text-gray-400">${stats.conducted}</td>
                    <td class="px-4 py-2 text-center text-sm font-bold ${textColorClass}">${percentage.toFixed(2)}%</td>
                </tr>`;
        tableBody.innerHTML += row;
      }

      const toggleBtn = document.getElementById('toggle-details-btn');
      if (toggleBtn.textContent === 'Hide Details') {
        container.classList.remove('hidden');
      }
    }

    function abbreviateSubjectName(fullName, minLength = 9) {
      if (fullName.length < minLength) {
        return fullName;
      }
      const stopWords = ['and', 'the', 'in', 'for', 'a', 'an'];
      const sanitizedName = fullName.replace(/[-/]/g, ' ');
      const words = sanitizedName.split(' ');
      const acronym = words
        .filter(word => word.length > 0 && !stopWords.includes(word.toLowerCase()))
        .map(word => word[0].toUpperCase())
        .join('');
      return acronym;
    }

    function calculateCustomMissable() {
      const totalAttended = parseFloat(document.getElementById('total-attended').textContent) || 0;
      const totalConducted = parseFloat(document.getElementById('total-conducted').textContent) || 0;
      const targetPercentage = parseFloat(document.getElementById('target-percent').value) / 100;
      const customAttendInput = parseInt(document.getElementById('custom-attend').value) || 0;
      const outputEl = document.getElementById('custom-missable-result');

      outputEl.classList.add('hidden');
      if (customAttendInput <= 0 || isNaN(customAttendInput)) return;

      const numerator = (totalAttended + customAttendInput) - (targetPercentage * (totalConducted + customAttendInput));
      const maxSkips = Math.floor(numerator / targetPercentage);

      if (maxSkips < 0) {
        outputEl.textContent = `⚠️ Even after attending ${customAttendInput} more classes, you cannot reach ${targetPercentage * 100}% attendance.`;
        outputEl.classList.remove('text-gray-800');
        outputEl.classList.add('text-red-600');
      } else {
        const projectedConducted = totalConducted + customAttendInput + maxSkips;
        const projectedAttended = totalAttended + customAttendInput;
        const projectedPercent = (projectedAttended / projectedConducted) * 100;
        const maxFutureAbsence = parseInt(document.getElementById('max-drop')?.textContent) || 0;

        outputEl.innerHTML = `✅ If you attend <strong>${customAttendInput}</strong> more classes, you can afford to miss <strong>${maxSkips}</strong> classes <em>(instead of ${maxFutureAbsence})</em>.<br>
                🧾 According to this, you will have attended <strong>${projectedAttended}</strong> out of <strong>${projectedConducted}</strong> classes.<br>
                📊 Projected Attendance: <strong>${projectedPercent.toFixed(2)}%</strong>`;
        outputEl.classList.remove('text-red-600');
        outputEl.classList.add('text-gray-800');
      }
      outputEl.classList.remove('hidden');
    }

    function toggleAdvancedDetails() {
      const dataInputWrapper = document.getElementById('data-input-wrapper');
      const subjectBreakdownContainer = document.getElementById('subject-breakdown-container');
      const toggleBtn = document.getElementById('toggle-details-btn');
      const isCurrentlyHidden = dataInputWrapper.classList.contains('hidden');

      if (isCurrentlyHidden) {
        dataInputWrapper.classList.remove('hidden');
        toggleBtn.textContent = 'Hide Details';
        const tableBody = document.getElementById('subject-breakdown-body');
        if (tableBody.innerHTML.trim() !== '') {
          subjectBreakdownContainer.classList.remove('hidden');
        }
      } else {
        dataInputWrapper.classList.add('hidden');
        subjectBreakdownContainer.classList.add('hidden');
        toggleBtn.textContent = 'Show Details';
      }
    }

    function toggleProjection() {
      document.getElementById('projection-container').classList.toggle('hidden');
    }

    function updateDurationMode() {
      const durationType = document.querySelector('input[name="projectionMode"]:checked').value;
      const remainingTimeLabel = document.getElementById('remaining-time-label');
      const daysPerWeekContainer = document.getElementById('days-per-week-container');

      if (durationType === 'weeks') {
        remainingTimeLabel.textContent = 'Remaining Weeks';
        daysPerWeekContainer.classList.add('hidden');
      } else {
        remainingTimeLabel.textContent = 'Remaining Days';
        daysPerWeekContainer.classList.remove('hidden');
      }
      calculateHours();
    }

    // --- START: FILE HANDLING LOGIC (FROM SCRIPT 2) ---
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-upload');

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-blue-500', 'bg-blue-50');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-blue-500', 'bg-blue-50');
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      const errorElement = document.getElementById('error-message');
      errorElement.classList.add('hidden');
      errorElement.textContent = '';
      const dropzoneElement = document.getElementById('dropzone'); // Get the element

      const ext = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      if (ext === 'csv') {
        reader.onload = function (e) {
          const text = e.target.result;
          document.getElementById('data-input').value = text.trim();
          // Reset overlay session to allow it to show again for new data
          sessionStorage.removeItem('overlayShownThisSession');
          dropzoneElement.classList.add('drop-success-animation');
          calculateHours();
          setTimeout(() => {
            dropzoneElement.classList.remove('drop-success-animation');
          }, 800);
        };
        reader.readAsText(file);
      } else if (ext === 'xlsx') {
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            if (!workbook.SheetNames.length) {
              throw new Error("No sheets found in Excel file.");
            }
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const csvText = XLSX.utils.sheet_to_csv(firstSheet);
            if (!csvText.trim()) {
              throw new Error("Excel sheet appears to be empty or improperly formatted.");
            }
            document.getElementById('data-input').value = csvText.trim();
            // Reset overlay session to allow it to show again for new data
            sessionStorage.removeItem('overlayShownThisSession');
            dropzoneElement.classList.add('drop-success-animation');
            calculateHours();
            setTimeout(() => {
              dropzoneElement.classList.remove('drop-success-animation');
            }, 800);
          } catch (error) {
            showError(`Error reading Excel file: ${error.message}`);
          }
        };
        reader.onerror = function () {
          showError("Failed to read the file. Please try again or use a different file.");
        };
        reader.readAsArrayBuffer(file);
      } else {
        showError('Unsupported file format. Please upload a .csv or .xlsx file.');
      }
    }

    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }
    // --- END: FILE HANDLING LOGIC ---


    function saveProgress() {
      const data = {
        attendanceData: document.getElementById('data-input').value,
        targetPercent: document.getElementById('target-percent').value,
        projectionMode: document.querySelector('input[name="projectionMode"]:checked')?.value || 'weeks',
        remainingTime: document.getElementById('remaining-time').value,
        classesPerWeek: document.getElementById('classes-per-week').value,
        daysPerWeek: document.getElementById('days-per-week').value,
      };
      localStorage.setItem('attendanceProgress', JSON.stringify(data));
      showToast('✅ Progress saved! You can resume later using the "↩️ Resume" button.');
    }

    function loadProgress() {
      const saved = localStorage.getItem('attendanceProgress');
      if (!saved) {
        showToast('⚠️ No saved progress found.');
        return;
      }
      try {
        const data = JSON.parse(saved);
        document.getElementById('data-input').value = data.attendanceData || '';
        document.getElementById('target-percent').value = data.targetPercent || 65;
        const projectionModeRadio = document.querySelector(`input[name="projectionMode"][value="${data.projectionMode || 'weeks'}"]`);
        if (projectionModeRadio) {
          projectionModeRadio.checked = true;
        }
        document.getElementById('remaining-time').value = data.remainingTime || 0;
        document.getElementById('classes-per-week').value = data.classesPerWeek || 0;
        document.getElementById('days-per-week').value = data.daysPerWeek || 6;
        updateDurationMode();
        calculateHours();
        showToast("✅ Progress successfully loaded.");
      } catch (error) {
        console.error("Failed to parse saved progress:", error);
        showToast('❌ Could not load corrupted saved data.');
        localStorage.removeItem('attendanceProgress');
      }
    }

    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.remove('hidden');
      toast.classList.add('flex');
      setTimeout(() => {
        toast.classList.add('hidden');
        toast.classList.remove('flex');
      }, duration);
    }

    document.querySelectorAll('input[name="loadOption"]').forEach((radio) => {
      radio.addEventListener('change', () => {
        localStorage.setItem('loadPreference', radio.value);
      });
    });

    window.addEventListener('load', async () => {
      const preference = localStorage.getItem('loadPreference') || 'none';
      if (preference === 'resume') {
        const saved = localStorage.getItem('attendanceProgress');
        if (saved) {
          loadProgress();
          showToast("✅ Progress restored automatically.");
        }
      } else if (preference === 'clipboard') {
        try {
          if (navigator.clipboard && navigator.clipboard.readText) {
            const text = await navigator.clipboard.readText();
            if (text) {
              document.getElementById('data-input').value = text;
              sessionStorage.removeItem('overlayShownThisSession');
              calculateHours?.();
              showToast("📋 Text pasted from clipboard.");
            }
          }
        } catch (err) {
          console.log('Clipboard read failed or denied:', err);
        }
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const preference = localStorage.getItem('loadPreference') || 'none';
      const radio = document.querySelector(`input[name="loadOption"][value="${preference}"]`);
      if (radio) radio.checked = true;
    });

    // REPLACE your old 'paste-btn' event listener with this one.
    document.getElementById('paste-btn').addEventListener('click', async () => {
      // First, check if the Clipboard API is even supported by the browser.
      if (!navigator.clipboard || !navigator.clipboard.readText) {
        showToast('📋 This browser does not support pasting from the clipboard.');
        return;
      }

      try {
        const text = await navigator.clipboard.readText();
        if (text) {
          const dataInput = document.getElementById('data-input');
          dataInput.value = text;
          sessionStorage.removeItem('overlayShownThisSession');
          calculateHours();
          showToast('📋 Pasted from clipboard!'); // Success message
        } else {
          showToast('📋 Clipboard is empty.'); // Handle case where clipboard has no text
        }
      } catch (err) {
        // Log the technical error for debugging, but don't show it to the user.
        console.error("Clipboard paste error:", err);

        // Show a user-friendly toast notification instead of an alert.
        if (err.name === 'NotAllowedError') {
          showToast('📋 Pasting permission was denied.');
        } else {
          showToast('❌ Could not paste from clipboard.');
        }
      }
    });

    function showMaxDropOverlay(maxDropValue, requiredClasses) {
      if (sessionStorage.getItem('overlayShownThisSession')) {
        return;
      }
      const showOverlayPref = localStorage.getItem('showOverlay');
      if (showOverlayPref === 'no') return;

      const overlay = document.getElementById('max-drop-overlay');
      const card = document.getElementById('max-drop-card');
      const message = document.getElementById('max-drop-message');
      const details = document.getElementById('max-drop-details');
      const lottieContainer = document.getElementById('lottie-container');

      // Reset previous state classes
      card.classList.remove('glow-success', 'glow-warning', 'glow-danger');
      let detailText = '';

      if (maxDropValue >= 10) {
        message.innerHTML = `😎 <span class="gradient-text-success">Great News!</span> 🎉`;
        detailText = `You can afford to miss <strong>${maxDropValue}</strong> classes. Keep it up!`;
        card.classList.add('glow-success');
        // loadLottie(lottieContainer, 'https://assets2.lottiefiles.com/packages/lf20_touohxv0.json');
        loadLottie(lottieContainer, './attendance-drop-calculator/succ.json');
      } else if (maxDropValue > 0) {
        message.innerHTML = `😬 <span class="gradient-text-warning">Heads Up</span> ⚠️`;
        detailText = `You only have <strong>${maxDropValue}</strong> skip(s) left. Plan wisely.`;
        card.classList.add('glow-warning');
        loadLottie(lottieContainer, './attendance-drop-calculator/warn.json');
      } else {
        message.innerHTML = `🚨 <span class="gradient-text-danger">No More Skips!</span> ❌`;
        detailText = `You must attend the next <strong>${requiredClasses}</strong> classes consecutively to recover.`;
        card.classList.add('glow-danger');
        loadLottie(lottieContainer, './attendance-drop-calculator/doomed.json');
      }

      // Make the numbers in the details pop
      details.innerHTML = detailText.replace(/<strong>(\d+)<\/strong>/g, '<strong class="text-4xl font-bold text-black dark:text-white mx-1">$1</strong>');

      overlay.classList.remove('hidden');
      setTimeout(() => {
        card.classList.remove('translate-y-full'); // Trigger slide-up animation
        sessionStorage.setItem('overlayShownThisSession', 'true');
      }, 20);
    }

    function dismissMaxDropOverlay() {
      const card = document.getElementById('max-drop-card');
      const overlay = document.getElementById('max-drop-overlay');

      card.classList.add('translate-y-full'); // Trigger slide-down animation

      // Wait for animation to finish before hiding the overlay
      setTimeout(() => {
        overlay.classList.add('hidden');
      }, 500); // This duration should match the CSS transition duration
    }

    document.getElementById('max-drop-overlay').addEventListener('click', (event) => {
      if (event.target === event.currentTarget) {
        dismissMaxDropOverlay();
      }
    });

    function loadLottie(container, url) {
      if (lottieAnimation) {
        lottieAnimation.destroy();
      }
      container.innerHTML = '';
      lottieAnimation = lottie.loadAnimation({
        container: container,
        renderer: 'svg',
        loop: true,
        autoplay: true,
        path: url
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('show-overlay-toggle');
      const pref = localStorage.getItem('showOverlay');
      toggle.checked = pref !== 'no';
    });

    document.getElementById('show-overlay-toggle').addEventListener('change', (e) => {
      localStorage.setItem('showOverlay', e.target.checked ? 'yes' : 'no');
    });

    function clearTextarea() {
      if (confirm("Are you sure you want to clear the attendance data?")) {
        document.getElementById('data-input').value = '';
        // Recalculate to reset the results
        calculateHours();
      }
    }

    // --- Charting Logic ---
    window.overallDonutChartInstance = null;
    window.subjectBarChartInstance = null;

    function drawOverallDonutChart(totalPresent, totalOD, totalAbsent) {
      const ctx = document.getElementById('overallDonutChart').getContext('2d');
      const overallChartContainer = document.getElementById('overall-chart-container');
      overallChartContainer.classList.remove('hidden');

      const textColor = document.documentElement.classList.contains('dark') ? '#f9fafb' : '#1f2937';
      const successColor = document.documentElement.classList.contains('dark') ? '#4ade80' : '#16a34a';
      const warningColor = document.documentElement.classList.contains('dark') ? '#fbbf24' : '#f59e0b';
      const errorColor = document.documentElement.classList.contains('dark') ? '#f87171' : '#dc2626';

      const data = {
        labels: ['Present', 'OD', 'Absent'],
        datasets: [{
          data: [totalPresent, totalOD, totalAbsent],
          backgroundColor: [successColor, warningColor, errorColor],
          hoverBackgroundColor: [successColor, warningColor, errorColor],
          borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff',
          borderWidth: 2
        }]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '70%',
        plugins: {
          legend: { labels: { color: textColor, font: { size: 14 } }, position: 'right' },
          title: { display: false }
        },
        animation: { animateScale: true, animateRotate: true }
      };

      window.overallDonutChartInstance = new Chart(ctx, { type: 'doughnut', data: data, options: options });
    }

    function drawSubjectBarChart(subjectStats, targetPercentage) {
      const ctx = document.getElementById('subjectBarChart').getContext('2d');
      const subjectChartContainer = document.getElementById('subject-chart-container');

      if (Object.keys(subjectStats).length === 0) {
        subjectChartContainer.classList.add('hidden');
        return;
      }
      subjectChartContainer.classList.remove('hidden');

      const labels = [], percentages = [], backgroundColors = [];
      const textColor = document.documentElement.classList.contains('dark') ? '#f9fafb' : '#1f2937';
      const greenColor = document.documentElement.classList.contains('dark') ? '#4ade80' : '#16a34a';
      const redColor = document.documentElement.classList.contains('dark') ? '#f87171' : '#dc2626';
      const gridColor = document.documentElement.classList.contains('dark') ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
      const borderColor = document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb';

      const sortedSubjects = Object.keys(subjectStats).sort();

      for (const subjectName of sortedSubjects) {
        const stats = subjectStats[subjectName];
        if (stats.conducted === 0) continue;

        const percentage = (stats.attended / stats.conducted) * 100;
        const displayName = abbreviateSubjectName(subjectName);
        labels.push(displayName);
        percentages.push(percentage.toFixed(2));
        backgroundColors.push(percentage >= targetPercentage ? greenColor : redColor);
      }

      const data = {
        labels: labels,
        datasets: [{ label: 'Attendance %', data: percentages, backgroundColor: backgroundColors, borderWidth: 1 }]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function (context) {
                const originalLabel = sortedSubjects[context.dataIndex];
                let percentageLabel = context.dataset.label || '';
                if (percentageLabel) { percentageLabel += ': '; }
                if (context.parsed.x !== null) { percentageLabel += context.parsed.x.toFixed(2) + '%'; }
                return [originalLabel, percentageLabel];
              }
            }
          }
        },
        scales: {
          x: {
            title: { display: true, text: 'Attendance Percentage', color: textColor },
            min: 0, max: 100, ticks: { color: textColor },
            grid: { color: gridColor, borderColor: borderColor }
          },
          y: { ticks: { color: textColor }, grid: { display: false } }
        },
        animation: { duration: 1000, easing: 'easeOutQuart' }
      };

      if (window.subjectBarChartInstance) {
        window.subjectBarChartInstance.destroy();
      }
      window.subjectBarChartInstance = new Chart(ctx, { type: 'bar', data: data, options: options });
    }

    const themeToggleBtn = document.getElementById('theme-toggle');
    const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

    // Function to apply the theme and update the icon visibility
    function applyTheme(isDarkMode) {
      if (isDarkMode) {
        document.documentElement.classList.add('dark');
        themeToggleLightIcon.classList.remove('hidden');
        themeToggleDarkIcon.classList.add('hidden');
      } else {
        document.documentElement.classList.remove('dark');
        themeToggleDarkIcon.classList.remove('hidden');
        themeToggleLightIcon.classList.add('hidden');
      }
    }

    // Check user's preference on page load
    // This logic runs immediately to prevent a "flash" of the wrong theme
    if (
      localStorage.getItem('color-theme') === 'dark' ||
      (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
    ) {
      applyTheme(true);
    } else {
      applyTheme(false);
    }

    // Add click event listener to the toggle button
    themeToggleBtn.addEventListener('click', function () {
      const isCurrentlyDark = document.documentElement.classList.contains('dark');

      if (isCurrentlyDark) {
        localStorage.setItem('color-theme', 'light');
        applyTheme(false);
      } else {
        localStorage.setItem('color-theme', 'dark');
        applyTheme(true);
      }
      if (document.getElementById('data-input').value.trim() !== '') {
        calculateHours();
      }
    });

    // Function to animate numbers counting up
    function animateValue(element, start, end, duration) {
      let startTimestamp = null;
      const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const currentValue = Math.floor(progress * (end - start) + start);
        element.textContent = currentValue;
        if (progress < 1) {
          window.requestAnimationFrame(step);
        }
      };
      window.requestAnimationFrame(step);
    }

    // --- START: Holiday Planner Logic ---

    // This function handles the new toggle UI
    function updateHolidayInputMode() {
      const mode = document.querySelector('input[name="holidayInputMode"]:checked').value;
      const daysInput = document.getElementById('holiday-input-days');
      const classesInput = document.getElementById('holiday-input-classes');

      if (mode === 'days') {
        daysInput.classList.remove('hidden');
        classesInput.classList.add('hidden');
      } else {
        daysInput.classList.add('hidden');
        classesInput.classList.remove('hidden');
      }
    }

    // Add event listeners to the radio buttons to trigger the UI change
    document.querySelectorAll('input[name="holidayInputMode"]').forEach(radio => {
      radio.addEventListener('change', updateHolidayInputMode);
    });

    // Run it once on load to set the initial state
    document.addEventListener('DOMContentLoaded', updateHolidayInputMode);

    function calculateHolidayImpact() {
      // --- 1. Get all required values ---
      const resultEl = document.getElementById('holiday-impact-result');
      const mode = document.querySelector('input[name="holidayInputMode"]:checked').value;
      const classesToAttendBefore = parseInt(document.getElementById('attend-before-leave').value) || 0;

      let totalMissedClasses = 0;
      let leaveDescription = "";

      // --- 2. Validate Inputs and determine total missed classes based on mode ---
      if (mode === 'days') {
        const holidayDays = parseInt(document.getElementById('holiday-days').value);
        const classesPerDay = parseInt(document.getElementById('classes-per-holiday-day').value);
        if (isNaN(holidayDays) || holidayDays < 0 || isNaN(classesPerDay) || classesPerDay <= 0) {
          resultEl.innerHTML = 'Please enter valid numbers for holiday days and classes per day.';
          resultEl.className = 'mt-4 p-4 rounded-lg font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300';
          resultEl.classList.remove('hidden');
          return;
        }
        totalMissedClasses = holidayDays * classesPerDay;
        leaveDescription = `a <strong>${holidayDays}-day</strong> leave (~${totalMissedClasses} classes missed)`;
      } else { // mode === 'classes'
        totalMissedClasses = parseInt(document.getElementById('total-missed-classes').value);
        if (isNaN(totalMissedClasses) || totalMissedClasses < 0) {
          resultEl.innerHTML = 'Please enter a valid number of total classes to miss.';
          resultEl.className = 'mt-4 p-4 rounded-lg font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-500/20 dark:text-yellow-300';
          resultEl.classList.remove('hidden');
          return;
        }
        leaveDescription = `a leave of <strong>${totalMissedClasses}</strong> classes`;
      }

      // --- 3. Get current attendance data ---
      const currentTotalAttended = parseFloat(document.getElementById('total-attended').textContent);
      const currentTotalConducted = parseFloat(document.getElementById('total-conducted').textContent);
      const targetPercent = parseFloat(document.getElementById('target-percent').value);

      if (isNaN(currentTotalAttended) || isNaN(currentTotalConducted) || currentTotalConducted === 0) {
        resultEl.innerHTML = 'Please calculate your current attendance before planning holidays.';
        resultEl.className = 'mt-4 p-4 rounded-lg font-medium bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300';
        resultEl.classList.remove('hidden');
        return;
      }

      // --- 4. Perform the NEW Holiday Calculation ---
      // First, calculate the state AFTER attending the extra classes
      const attendedAfterExtra = currentTotalAttended + classesToAttendBefore;
      const conductedAfterExtra = currentTotalConducted + classesToAttendBefore;

      // Now, calculate the final state AFTER the leave
      const conductedAfterHoliday = conductedAfterExtra + totalMissedClasses;
      const attendedAfterHoliday = attendedAfterExtra; // Attended hours don't change during the leave
      const percentageAfterHoliday = (attendedAfterHoliday / conductedAfterHoliday) * 100;

      let message = `
      <h3 class="font-bold text-lg mb-2">Holiday Impact Analysis</h3>
      <p class="text-sm">By first attending <strong>${classesToAttendBefore}</strong> classes and then taking ${leaveDescription}, your new attendance would be:</p>
      <ul class="list-disc list-inside text-sm my-2 space-y-1">
        <li>Total Attended: <strong>${attendedAfterHoliday}</strong></li>
        <li>Total Conducted: <strong>${conductedAfterHoliday}</strong></li>
      </ul>
      <p class="text-xl font-bold">Projected Attendance: <span class="${percentageAfterHoliday >= targetPercent ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">${percentageAfterHoliday.toFixed(2)}%</span></p>
    `;

      // --- 5. Determine if they are safe and calculate recovery if needed ---
      if (percentageAfterHoliday >= targetPercent) {
        resultEl.className = 'mt-4 p-4 rounded-lg text-left font-medium bg-green-100 text-green-800 dark:bg-green-500/20 dark:text-green-300';
        message += `
            <hr class="my-3 border-green-300 dark:border-green-700">
            <p class="font-semibold">✅ This plan is safe! Your attendance will remain above the ${targetPercent}% target.</p>
        `;
      } else {
        resultEl.className = 'mt-4 p-4 rounded-lg text-left font-medium bg-red-100 text-red-800 dark:bg-red-500/20 dark:text-red-300';
        const requiredRecoveryClasses = Math.ceil(
          ((targetPercent / 100) * conductedAfterHoliday - attendedAfterHoliday) / (1 - (targetPercent / 100))
        );
        message += `
            <hr class="my-3 border-red-300 dark:border-red-700">
            <p class="font-semibold">⚠️ This plan will drop your attendance below the target!</p>
            <p class="mt-2">To recover, you will need to attend approx. <strong>${requiredRecoveryClasses}</strong> consecutive classes <strong>after</strong> your leave.</p>
        `;
      }

      resultEl.innerHTML = message;
      resultEl.classList.remove('hidden');
    }
  </script>
</body>

</html>