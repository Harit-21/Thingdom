<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aggregate Attendance Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f7f9fb;
    }

    .card {
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }

    textarea {
      min-height: 200px;
    }
  </style>
</head>

<body class="p-4 sm:p-8">

  <div id="app" class="max-w-4xl mx-auto">
    <header class="text-center mb-8">
      <h1 class="text-4xl font-bold text-gray-800 tracking-tight">Attendance Drop Calculator</h1>
      <p class="text-gray-500 mt-2">Calculate max future absences to stay above a target percentage.</p>
    </header>

    <div class="card bg-white p-6 sm:p-8 rounded-xl border border-gray-200">
      <!-- Instructions and Inputs -->
      <div class="space-y-6">

        <!-- <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV or Excel File:</label>
          <input type="file" id="file-upload" accept=".csv, .xlsx"
            class="w-full p-2 border border-gray-300 rounded-lg bg-white cursor-pointer"
            onchange="handleFileUpload(event)">
          <p class="text-xs text-gray-500 mt-1">Accepted formats: .csv, .xlsx</p>
        </div> -->

        <!-- Dropzone for file upload -->
        <div id="dropzone"
          class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg bg-white text-center text-gray-500 hover:border-blue-400 transition cursor-pointer">
          <p class="mb-2 font-medium">Drag and drop a CSV/XLSX file here</p>
          <p class="text-xs text-gray-400">or click to select a file</p>
          <input type="file" id="file-upload" accept=".csv,.xlsx" class="hidden" onchange="handleFileUpload(event)">
        </div>



        <!-- Target Percentage Input -->
        <div>
          <label for="target-percent" class="block text-sm font-medium text-gray-700 mb-2">Target Attendance Percentage
            (e.g., 65):</label>
          <input type="number" id="target-percent" value="65" min="1" max="100"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
            oninput="calculateHours()">
        </div>

        <!-- Data Input Area -->
        <div>
          <label for="data-input" class="block text-sm font-medium text-gray-700 mb-2">Paste Attendance Data
            Here:</label>
          <p class="text-xs text-gray-500 mb-2">Ensure your data includes columns for 'Present', 'OD', and 'Absent'.</p>
          <button id="paste-btn"
            class="block mx-auto px-4 py-3 my-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:from-indigo-600 hover:to-blue-500 transition duration-300 transform hover:-translate-y-1 focus:outline-none focus:ring-4 focus:ring-blue-300">
            Paste 📋
          </button>


          <textarea id="data-input"
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 resize-none transition duration-150"
            placeholder="Paste your table data (tab-separated or space-separated) here..."></textarea>
        </div>

        <!-- Calculate Button (for clarity, though it auto-updates) -->
        <button onclick="calculateHours()"
          class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700 transition duration-200 shadow-md hover:shadow-lg">
          Calculate Max Missable Hours
        </button>
      </div>

      <hr class="my-8 border-gray-200">

      <!-- Results Section -->
      <div id="results" class="space-y-4">
        <h2 class="text-2xl font-semibold text-gray-800 border-b pb-2">Results</h2>

        <div id="summary-metrics" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div class="bg-gray-50 p-3 rounded-lg">
            <p class="text-xs text-gray-500">Total Attended</p>
            <p id="total-attended" class="text-xl font-bold text-green-600">0</p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <p class="text-xs text-gray-500">Total Conducted</p>
            <p id="total-conducted" class="text-xl font-bold text-gray-600">0</p>
          </div>
          <div class="bg-gray-50 p-3 rounded-lg">
            <p class="text-xs text-gray-500">Current %</p>
            <p id="current-percent" class="text-xl font-bold text-yellow-600">0.00%</p>
          </div>
          <div class="bg-blue-100 p-3 rounded-lg border-2 border-blue-400">
            <p class="text-xs text-blue-700 font-semibold">Max Future Absences</p>
            <p id="max-drop" class="text-2xl font-extrabold text-blue-600">0</p>
          </div>
        </div>

        <div id="message-box" class="mt-6 p-4 rounded-lg text-center font-medium transition duration-300 hidden"
          role="alert"></div>

        <div id="error-message"
          class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden transition duration-300 ease-in-out">
        </div>
      </div>

      <!-- Projection & Visuals Toggle -->
      <div class="mt-10 flex items-center justify-between">
        <h2 class="text-xl font-semibold text-gray-800">Projection & Planner</h2>
        <button onclick="toggleProjection()" class="text-sm text-blue-600 hover:underline">
          Toggle View
        </button>
      </div>

      <div id="projection-container" class="mt-4 hidden">
        <!-- Input Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Duration Type</label>
            <select id="duration-type" onchange="updateDurationMode()" class="w-full p-2 border rounded-lg">
              <option value="weeks">Weeks</option>
              <option value="days">Days</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Remaining Time</label>
            <input type="number" id="remaining-time" value="6" class="w-full p-2 border rounded-lg"
              oninput="calculateHours()" min="1">
          </div>

          <!-- Conditionally shown -->
          <div id="classes-per-week-container">
            <label class="block text-sm font-medium text-gray-700 mb-1">Classes per Week</label>
            <input type="number" id="classes-per-week" value="18" class="w-full p-2 border rounded-lg"
              oninput="calculateHours()" min="1">
          </div>

          <!-- For day-based input -->
          <div id="days-options" class="hidden md:col-span-2 grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Days per Week</label>
              <select id="days-per-week" class="w-full p-2 border rounded-lg" onchange="calculateHours()">
                <option value="6">6 days</option>
                <option value="5">5 days</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Avg Classes per Day</label>
              <input type="number" id="classes-per-day" value="3" class="w-full p-2 border rounded-lg" min="1"
                oninput="calculateHours()">
            </div>
          </div>
        </div>


        <!-- Projection Summary -->
        <div id="projection-output" class="mt-6 bg-gray-100 p-4 rounded-lg hidden">
          <p class="text-gray-700"><strong>Total Remaining Classes: &nbsp ~</strong> <span
              id="total-remaining-classes"></span>
          </p>
          <p class="text-gray-700"><strong>Classes You Must Attend: &nbsp ~</strong> <span
              id="required-attendance"></span></p>
          <p class="text-gray-700"><strong>Classes You Can Skip: &nbsp ~</strong> <span id="allowed-skips"></span></p>
          <p class="text-gray-700"><strong>Projected Attendance (afterwards): </strong> <span
              id="projected-percent" class="font-semibold"></span>
          </p>
        </div>

        <!-- Progress Graph -->
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Attendance Progress</label>
          <div class="relative w-full bg-gray-200 rounded-full h-6 overflow-hidden">
            <div id="attendance-bar"
              class="absolute top-0 left-0 h-6 bg-green-500 text-white text-xs text-center leading-6 transition-all duration-300"
              style="width: 0%">0%</div>
            <div class="absolute top-0 h-6 border-l-2 border-red-500" id="target-marker" style="left: 65%;"></div>
          </div>
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0%</span>
            <span>Target</span>
            <span>100%</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    document.getElementById('data-input').addEventListener('input', calculateHours);
    document.addEventListener('DOMContentLoaded', () => {
      // Load the user's sample data to show how it works
      const sampleData = `Introductory Text
            This is some metadata
            #	Subject Code	Subject	Subject Type	Present	OD	Absent	Percentage
            1	5CDS-01	Data Mining Concepts and Techniques	Lecture	13	0	2	86.67
            2	5CDS-02	Compiler Design	Lecture	19	0	4	82.61
            3	5CDS-03	Operating System	Lecture	20	0	3	86.96
            4	5CDS-04	Data Visualization- R Programming/ Power BI	Lecture	23	0	1	95.83
            5	5CDS-05	Analysis of Algorithm	Lecture	20	0	4	83.33
            6	5CDS-11	Fundamentals of Block chain	Lecture	10	0	6	62.50
            7	5CDS-21	R Programming Lab	Lab	16	0	0	100.00
            8	5CDS-22	Compiler Design Lab	Lab	16	0	0	100.00
            9	5CDS-23	Analysis of Algorithm Lab	Lab	16	0	0	100.00
            10	5CDS-24	Advanced Java Lab	Lab	16	0	0	100.00
            11	5CDS-30	Industrial Training	Lab	5	0	1	83.33
            12	CRT	Campus Recruitment Training	Lab	8	0	38	17.39`;
      document.getElementById('data-input').value = sampleData.trim();
      calculateHours();
    });

    function showMessage(type, text) {
      const messageBox = document.getElementById('message-box');
      messageBox.innerHTML = text;
      messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'text-red-700', 'text-green-700');

      if (type === 'success') {
        messageBox.classList.add('bg-green-100', 'text-green-700');
      } else if (type === 'error') {
        messageBox.classList.add('bg-red-100', 'text-red-700');
      }
    }

    function calculateHours() {
      const dataInput = document.getElementById('data-input').value.trim();
      const targetPercentInput = document.getElementById('target-percent').value;
      const errorElement = document.getElementById('error-message');
      const resultElements = {
        attended: document.getElementById('total-attended'),
        conducted: document.getElementById('total-conducted'),
        current: document.getElementById('current-percent'),
        drop: document.getElementById('max-drop')
      };

      errorElement.classList.add('hidden');
      document.getElementById('message-box').classList.add('hidden');

      // --- Input Validation ---
      if (!dataInput) {
        resultElements.attended.textContent = resultElements.conducted.textContent = resultElements.drop.textContent = '0';
        resultElements.current.textContent = '0.00%';
        showMessage('error', 'Please paste your attendance data to begin the calculation.');
        return;
      }

      const targetPercentage = parseFloat(targetPercentInput) / 100;
      if (isNaN(targetPercentage) || targetPercentage <= 0 || targetPercentage > 1) {
        errorElement.textContent = 'Invalid Target Percentage. Please enter a value between 1 and 100.';
        errorElement.classList.remove('hidden');
        return;
      }

      // --- Data Parsing ---
      const lines = dataInput.split('\n').filter(line => line.trim() !== '');

      let startRowIndex = 0;

      // Find the first row that contains the header columns "Present", "OD", "Absent"
      for (let i = 0; i < lines.length; i++) {
        const headerLine = lines[i].trim().toLowerCase();
        if (headerLine.includes('present') && headerLine.includes('od') && headerLine.includes('absent')) {
          startRowIndex = i;
          break;
        }
      }

      // Skip any rows before the valid data
      const validLines = lines.slice(startRowIndex);
      const headerLine = validLines[0];

      const separator = headerLine.includes('\t') ? '\t' : ' ';
      const headers = headerLine.split(separator).map(h => h.trim()).filter(h => h !== '');

      // Find index of required columns
      const presentIndex = headers.findIndex(h => h.toLowerCase().includes('present'));
      const odIndex = headers.findIndex(h => h.toLowerCase() === 'od' || h.toLowerCase().includes('duty'));
      const absentIndex = headers.findIndex(h => h.toLowerCase().includes('absent'));

      if (presentIndex === -1 || odIndex === -1 || absentIndex === -1) {
        errorElement.textContent = 'Could not find required columns: "Present", "OD", and "Absent" in the header row.';
        errorElement.classList.remove('hidden');
        return;
      }

      // --- Aggregate Summation ---
      let totalAttended = 0;
      let totalAbsent = 0;
      let totalConductableClasses = 0;

      for (let i = 1; i < validLines.length; i++) {
        // Use a regex to split by tabs or one or more spaces
        const values = validLines[i].split(/\t| {2,}/).map(v => v.trim()).filter(v => v !== '');

        // Ensure the row has enough columns
        if (values.length > Math.max(presentIndex, odIndex, absentIndex)) {
          const present = parseFloat(values[presentIndex]) || 0;
          const od = parseFloat(values[odIndex]) || 0;
          const absent = parseFloat(values[absentIndex]) || 0;

          totalAttended += (present + od);
          totalAbsent += absent;
          totalConductableClasses += (present + od + absent);
        }
      }

      // Handle scenario where no data was summed (e.g., non-numeric rows)
      if (totalConductableClasses === 0) {
        errorElement.textContent = 'No valid numeric attendance data could be aggregated from the rows.';
        errorElement.classList.remove('hidden');
        return;
      }

      // --- Calculation using the formula derived for future absences ---
      const numerator = totalAttended - (targetPercentage * totalConductableClasses);
      const maxDropFloat = numerator / targetPercentage;

      let maxDrop = Math.floor(maxDropFloat);

      if (maxDrop < 0) {
        maxDrop = 0;
        const requiredClasses = Math.ceil((targetPercentage * totalConductableClasses - totalAttended) / (1 - targetPercentage));

        showMessage(
          'error',
          `Your current aggregate attendance (${(totalAttended / totalConductableClasses * 100).toFixed(2)}%) is below the target of ${(targetPercentage * 100).toFixed(0)}%.<br>
    👉 You must attend at least <strong>${requiredClasses}</strong> more classes consecutively (without missing) to reach your target.`
        );
      }
      else {
        const newTotalConducted = totalConductableClasses + maxDrop;
        const resultingPercent = (totalAttended / newTotalConducted) * 100;

        showMessage('success', `If you miss ${maxDrop} more hours, your aggregate attendance will be ${resultingPercent.toFixed(2)}%, which is just above the ${targetPercentage * 100}% target.`);
      }

      // --- Update UI ---
      resultElements.attended.textContent = totalAttended.toFixed(0);
      resultElements.conducted.textContent = totalConductableClasses.toFixed(0);
      resultElements.current.textContent = `${(totalAttended / totalConductableClasses * 100).toFixed(2)}%`;
      resultElements.drop.textContent = maxDrop.toFixed(0);


      // --- Future Projection Calculation ---
      const durationType = document.getElementById('duration-type')?.value;
      const remainingTime = parseInt(document.getElementById('remaining-time')?.value) || 0;
      let classesPerWeek = 0;

      if (durationType === 'weeks') {
        classesPerWeek = parseInt(document.getElementById('classes-per-week')?.value) || 0;
      } else if (durationType === 'days') {
        const daysPerWeek = parseInt(document.getElementById('days-per-week')?.value) || 0;
        const classesPerDay = parseFloat(document.getElementById('classes-per-day')?.value) || 0;
        classesPerWeek = daysPerWeek * classesPerDay;
      }

      const projectionOutput = document.getElementById('projection-output');

      if (remainingTime > 0 && classesPerWeek > 0) {
        const totalRemainingClasses = remainingTime * classesPerWeek;
        const totalRequiredAttendance = Math.ceil((totalConductableClasses + totalRemainingClasses) * targetPercentage);
        const classesNeededToAttend = Math.max(0, totalRequiredAttendance - totalAttended);
        const possibleSkips = Math.max(0, totalRemainingClasses - classesNeededToAttend);
        const finalAttended = totalAttended + classesNeededToAttend;
        const finalConducted = totalConductableClasses + totalRemainingClasses;
        const projectedPercentage = ((finalAttended / finalConducted) * 100).toFixed(2);

        const projectedPercentEl = document.getElementById('projected-percent');
        projectedPercentEl.textContent = `${projectedPercentage}%`;

        // Color-code the percentage
        if (parseFloat(projectedPercentage) >= targetPercentage * 100) {
          projectedPercentEl.classList.remove('text-red-600');
          projectedPercentEl.classList.add('text-green-600');
        } else {
          projectedPercentEl.classList.remove('text-green-600');
          projectedPercentEl.classList.add('text-red-600');
        }

        // Display warning message if not possible to meet target
        if (classesNeededToAttend > totalRemainingClasses) {
          showMessage('error', `⚠️ Even if you attend all remaining ${totalRemainingClasses} classes, your attendance will be only ${projectedPercentage}%. You cannot reach the ${targetPercentage * 100}% target.`);
        }


        projectionOutput.classList.remove('hidden');
        document.getElementById('total-remaining-classes').textContent = totalRemainingClasses;
        document.getElementById('required-attendance').textContent = classesNeededToAttend;
        document.getElementById('allowed-skips').textContent = possibleSkips;
      } else {
        projectionOutput.classList.add('hidden');
      }


      // --- Update Progress Graph ---
      const progressBar = document.getElementById('attendance-bar');
      const marker = document.getElementById('target-marker');
      const currentPercent = (totalAttended / totalConductableClasses) * 100;
      const targetPercent = targetPercentage * 100;

      progressBar.style.width = `${Math.min(currentPercent, 100)}%`;
      progressBar.textContent = `${currentPercent.toFixed(1)}%`;
      progressBar.classList.remove('bg-green-500', 'bg-red-500');
      progressBar.classList.add(currentPercent >= targetPercent ? 'bg-green-500' : 'bg-red-500');

      marker.style.left = `${targetPercent}%`;




      // --- Future Projection Calculation ---
      // const durationType = document.getElementById('duration-type').value;
      // const remainingTime = parseInt(document.getElementById('remaining-time').value) || 0;
      // const classesPerUnit = parseInt(document.getElementById('classes-per-unit').value) || 0;

      // const totalRemainingClasses = remainingTime * classesPerUnit;

      // // Required total attendance to meet target
      // const totalRequiredAttendance = Math.ceil((totalConductableClasses + totalRemainingClasses) * targetPercentage);

      // // Remaining required attendance
      // const classesNeededToAttend = Math.max(0, totalRequiredAttendance - totalAttended);

      // // Allowed absences = Remaining classes - required attendance in remaining
      // const possibleSkips = Math.max(0, totalRemainingClasses - classesNeededToAttend);

      // // Update UI
      // document.getElementById('projection-output').classList.remove('hidden');
      // document.getElementById('total-remaining-classes').textContent = totalRemainingClasses;
      // document.getElementById('required-attendance').textContent = classesNeededToAttend;
      // document.getElementById('allowed-skips').textContent = possibleSkips;



    }

    function toggleProjection() {
      const container = document.getElementById('projection-container');
      container.classList.toggle('hidden');
    }

    function updateDurationMode() {
      const durationType = document.getElementById('duration-type').value;
      const weekInput = document.getElementById('classes-per-week-container');
      const dayOptions = document.getElementById('days-options');

      if (durationType === 'weeks') {
        weekInput.classList.remove('hidden');
        dayOptions.classList.add('hidden');
      } else {
        weekInput.classList.add('hidden');
        dayOptions.classList.remove('hidden');
      }

      calculateHours();
    }

    // Dropzone Logic
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('file-upload');

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-blue-500', 'bg-blue-50');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-blue-500', 'bg-blue-50');

      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function handleFile(file) {
      const errorElement = document.getElementById('error-message');
      errorElement.classList.add('hidden');
      errorElement.textContent = '';

      const ext = file.name.split('.').pop().toLowerCase();
      const reader = new FileReader();

      if (ext === 'csv') {
        reader.onload = function (e) {
          const text = e.target.result;
          document.getElementById('data-input').value = text.trim();
          calculateHours();
        };
        reader.readAsText(file);
      } else if (ext === 'xlsx') {
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            if (!workbook.SheetNames.length) {
              throw new Error("No sheets found in Excel file.");
            }

            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const csvText = XLSX.utils.sheet_to_csv(firstSheet);

            if (!csvText.trim()) {
              throw new Error("Excel sheet appears to be empty or improperly formatted.");
            }

            document.getElementById('data-input').value = csvText.trim();
            calculateHours();
          } catch (error) {
            showError(`Error reading Excel file: ${error.message}`);
          }
        };
        reader.onerror = function () {
          showError("Failed to read the file. Please try again or use a different file.");
        };
        reader.readAsArrayBuffer(file);
      } else {
        showError('Unsupported file format. Please upload a .csv or .xlsx file.');
      }
    }

    function showError(message) {
      const errorElement = document.getElementById('error-message');
      errorElement.textContent = message;
      errorElement.classList.remove('hidden');
    }

    window.addEventListener('load', async () => {
      try {
        // Check if Clipboard API is supported
        if (navigator.clipboard && navigator.clipboard.readText) {
          const text = await navigator.clipboard.readText();

          if (text) {
            // Put clipboard text inside the textarea
            const dataInput = document.getElementById('data-input');
            dataInput.value = text;

            // Optionally call your calculate function after pasting
            calculateHours();
          }
        }
      } catch (err) {
        // Could not read clipboard (probably permission denied)
        console.log('Clipboard read failed or denied:', err);
      }
    });

    document.getElementById('paste-btn').addEventListener('click', async () => {
      try {
        if (navigator.clipboard && navigator.clipboard.readText) {
          const text = await navigator.clipboard.readText();
          if (text) {
            const dataInput = document.getElementById('data-input');
            dataInput.value = text;
            calculateHours();  // Run your calculation function after pasting
          }
        } else {
          alert('Clipboard API not supported in this browser.');
        }
      } catch (err) {
        alert('Failed to read clipboard contents: ' + err);
      }
    });


  </script>
</body>

</html>